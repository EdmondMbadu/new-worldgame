<div class="dark:bg-slate-900 min-h-screen min-w-full">
    <!-- NAVBAR -->
    <app-navbar
      [sideBarSmall]="true"
      [sideBarBig]="false"
      [email]="auth.currentUser.email"
      [firstName]="auth.currentUser.firstName"
      [lastName]="auth.currentUser.lastName"
      path="home"
      current="">
    </app-navbar>
  
    <!-- TIMELINE / STEPS HEADER (centered) -->
    <!-- <div class="mt-20 container px-32 flex flex-row mx-auto justify-center">
      <ol class="items-center sm:flex">
        <li *ngFor="let step of steps; let i = index" class="relative mb-6 sm:mb-0">
          <div class="flex items-center">
            
            <div  
              (click)="goBackAndForthTimeLine(i)"
              
              class="z-10 flex items-center justify-center w-32 rounded-full shrink-0 cursor-pointer mt-4">
              
              <span
              [ngClass]="{'active': isCurrentStep(i)}"
                class="flex items-center justify-center w-16 h-16 border border-blue-600
                       rounded-full font-bold shrink-0 dark:border-blue-500 dark:text-white">
                {{ i + 1 }}
              </span>
              <div 
            *ngIf="i < steps.length-1 " 
            class="hidden sm:flex w-32 h-1 bg-gray-300 dark:bg-gray-700">
           
          </div>
          <div 
          *ngIf="i == steps.length-1 " 
          class="hidden sm:flex w-32 h-1 bg-white dark:bg-slate-900"></div>

            </div>
  
            
            <div class="hidden sm:flex w-full {{timelineDisplay[i]}} dark:bg-gray-700"></div>
          </div>
  
         
         
        </li>
      </ol>
    </div> -->
    <!-- TIMELINE / STEPS HEADER (centered) -->
<div class="mt-20 container px-32 flex flex-row mx-auto justify-center">
  <ol class="flex items-center space-x-0">
    <li *ngFor="let step of steps; let i = index" class="flex items-center relative">

      <!-- Line BEFORE image (touches image directly) -->
      <div 
        *ngIf="i !== 0"
        class="w-6 sm:w-24 h-1 transition-all duration-300"
        [ngClass]="isCurrentStep(i) ? 'bg-red-500' : 'bg-gray-300 dark:bg-gray-700'">
      </div>

      <!-- Step container (image + title, vertically stacked) -->
      <div class="flex flex-col items-center text-center">

        <!-- Image with red glow if current -->
        <div 
          (click)="goBackAndForthTimeLine(i)"
          class="z-10 flex items-center justify-center cursor-pointer transition-all duration-300"
          [ngClass]="isCurrentStep(i) ? 'ring-4 ring-red-500 rounded-full shadow-lg shadow-red-500/40' : ''">
          
          <img
            [src]="'../../../assets/img/step-' + (i + 1) + '.png'"
            alt="Step {{ i + 1 }} image"
            class="w-36 h-auto" />
        </div>

        <!-- Step title -->
        <div class="mt-2">
          <h1 class="text-lg font-semibold text-gray-800 dark:text-white">
           {{ step }}
          </h1>
  </div>
</div>

    </li>
  </ol>
</div>






  
    <!-- MAIN CONTENT: Questions (left/center) + Image & Text (right) -->
    <div
      class="container px-10 mx-auto mt-10 flex flex-col-reverse lg:flex-row 
             justify-center items-center lg:items-start gap-8">
  
      <!-- LEFT/CENTER: Display the current step questions -->
      <div class="w-full lg:w-2/3">
        <!-- We only want one step visible at a time -->
        <ng-container *ngFor="let item of AllQuestions; let i = index">
          <app-playground-step
            *ngIf="display[i]"
            (submissionComplete)="sendRequestForEvaluation()"
            [title]="currentSolution.title"
            [step]="steps[i]"
            [questions]="AllQuestions[i]"
            [questionsTitles]="questionsTitles[i]"
            [stepNumber]="currentIndexDisplay"
            [buttonText]="buttontexts[i]"
            [solutionId]="id"
            (buttonInfoEvent)="updatePlayground($event)">
          </app-playground-step>
        </ng-container>
      </div>
  
      <!-- RIGHT: Step image + “subtitle” for whichever step is active -->
      <div class="w-full lg:w-1/3 flex flex-col items-center lg:items-start mt-10">
        <ng-container *ngFor="let step of steps; let i = index">
          <div *ngIf="display[i]" class="flex flex-col items-center lg:items-start">
            <!-- Step Image -->
            <img
              [src]="'../../../assets/img/step-' + (i + 1) + '.png'"
              alt="Step {{ i + 1 }} image"
              class="w-60 h-auto mb-3" />
  
            <!-- Step subtitle or fallback if only one question -->
            <time
              *ngIf="AllQuestions[i].length > 1"
              class="block mb-2 text-xl font-normal leading-none text-gray-500 dark:text-gray-400">
              {{ subtitles[i] }}
            </time>
            <div *ngIf="i === 1" class="mb-2 text-sm font-medium text-teal-700 dark:text-teal-300">
              <a
                [routerLink]="preferredStateGraphicUrl"
                class="underline hover:text-teal-600 dark:hover:text-teal-200">
                {{ currentLanguage === 'fr' ? "Graphique sur l'état souhaité" : 'Graphic on Preferred State' }}
              </a>
            </div>
            <time
              *ngIf="AllQuestions[i].length == 1"
              class="block mb-2 text-xl font-normal leading-none text-gray-500 dark:text-gray-400">
              {{ 'playgroundSteps.finalReview.title' | translate }}
            </time>
            <div *ngIf="isFinalStep(i)" class="w-full mt-4">

              <!-- ═══════════════════════════════════════════════════════════════
                   STUDIO PANEL - Unified actions hub
                   ═══════════════════════════════════════════════════════════════ -->
              <div class="w-full rounded-2xl border border-slate-200/80 bg-white shadow-sm dark:border-slate-700/60 dark:bg-slate-900/80 overflow-hidden">

                <!-- Studio Header -->
                <div class="px-5 py-4 border-b border-slate-100 dark:border-slate-800">
                  <div class="flex items-center gap-3">
                    <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-gradient-to-br from-teal-500 to-emerald-600 shadow-sm">
                      <svg class="h-4 w-4 text-white" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.395m3.42 3.42a15.995 15.995 0 004.764-4.648l3.876-5.814a1.151 1.151 0 00-1.597-1.597L14.146 6.32a15.996 15.996 0 00-4.649 4.763m3.42 3.42a6.776 6.776 0 00-3.42-3.42" />
                      </svg>
                    </div>
                    <div>
                      <h3 class="text-base font-semibold text-slate-900 dark:text-white">Studio</h3>
                      <p class="text-xs text-slate-500 dark:text-slate-400">Export, evaluate, and create</p>
                    </div>
                  </div>
                </div>

                <!-- Action Tiles Grid -->
                <div class="p-4">
                  <div class="grid grid-cols-4 gap-2.5">

                    <!-- Tile 1: Export Draft -->
                    <div class="group relative">
                      <button
                        type="button"
                        (click)="studioActivePanel = studioActivePanel === 'export' ? null : 'export'"
                        [disabled]="!currentDraftText"
                        class="w-full flex flex-col items-center gap-2 rounded-xl border-2 px-2 py-3 transition-all disabled:opacity-40 disabled:cursor-not-allowed"
                        [ngClass]="studioActivePanel === 'export'
                          ? 'border-teal-400 bg-teal-50 dark:border-teal-500/60 dark:bg-teal-500/10'
                          : 'border-slate-200 bg-slate-50/50 hover:border-slate-300 hover:bg-slate-100/80 dark:border-slate-700 dark:bg-slate-800/50 dark:hover:border-slate-600 dark:hover:bg-slate-800'">
                        <div class="flex h-9 w-9 items-center justify-center rounded-lg bg-white shadow-sm ring-1 ring-slate-200/80 dark:bg-slate-700 dark:ring-slate-600">
                          <svg class="h-4.5 w-4.5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                          </svg>
                        </div>
                        <span class="text-[11px] font-semibold text-slate-700 dark:text-slate-200">Export</span>
                      </button>
                    </div>

                    <!-- Tile 2: AI Feedback -->
                    <div class="group relative">
                      <button
                        type="button"
                        (click)="studioActivePanel = studioActivePanel === 'feedback' ? null : 'feedback'"
                        class="w-full flex flex-col items-center gap-2 rounded-xl border-2 px-2 py-3 transition-all"
                        [ngClass]="studioActivePanel === 'feedback'
                          ? 'border-teal-400 bg-teal-50 dark:border-teal-500/60 dark:bg-teal-500/10'
                          : 'border-slate-200 bg-slate-50/50 hover:border-slate-300 hover:bg-slate-100/80 dark:border-slate-700 dark:bg-slate-800/50 dark:hover:border-slate-600 dark:hover:bg-slate-800'">
                        <div class="flex h-9 w-9 items-center justify-center rounded-lg bg-white shadow-sm ring-1 ring-slate-200/80 dark:bg-slate-700 dark:ring-slate-600">
                          <svg class="h-4.5 w-4.5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                          </svg>
                        </div>
                        <span class="text-[11px] font-semibold text-slate-700 dark:text-slate-200">Feedback</span>
                        <span *ngIf="aiFeedbackText" class="absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-emerald-500 text-[10px] font-bold text-white shadow">✓</span>
                      </button>
                    </div>

                    <!-- Tile 3: Report -->
                    <div class="group relative">
                      <button
                        type="button"
                        (click)="studioActivePanel = studioActivePanel === 'report' ? null : 'report'"
                        class="w-full flex flex-col items-center gap-2 rounded-xl border-2 px-2 py-3 transition-all"
                        [ngClass]="studioActivePanel === 'report'
                          ? 'border-teal-400 bg-teal-50 dark:border-teal-500/60 dark:bg-teal-500/10'
                          : 'border-slate-200 bg-slate-50/50 hover:border-slate-300 hover:bg-slate-100/80 dark:border-slate-700 dark:bg-slate-800/50 dark:hover:border-slate-600 dark:hover:bg-slate-800'">
                        <div class="flex h-9 w-9 items-center justify-center rounded-lg bg-white shadow-sm ring-1 ring-slate-200/80 dark:bg-slate-700 dark:ring-slate-600">
                          <svg class="h-4.5 w-4.5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                          </svg>
                        </div>
                        <span class="text-[11px] font-semibold text-slate-700 dark:text-slate-200">Report</span>
                        <span *ngIf="reportText" class="absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-emerald-500 text-[10px] font-bold text-white shadow">✓</span>
                      </button>
                    </div>

                    <!-- Tile 4: Infographic -->
                    <div class="group relative">
                      <button
                        type="button"
                        (click)="studioActivePanel = studioActivePanel === 'infographic' ? null : 'infographic'"
                        class="w-full flex flex-col items-center gap-2 rounded-xl border-2 px-2 py-3 transition-all"
                        [ngClass]="studioActivePanel === 'infographic'
                          ? 'border-teal-400 bg-teal-50 dark:border-teal-500/60 dark:bg-teal-500/10'
                          : 'border-slate-200 bg-slate-50/50 hover:border-slate-300 hover:bg-slate-100/80 dark:border-slate-700 dark:bg-slate-800/50 dark:hover:border-slate-600 dark:hover:bg-slate-800'">
                        <div class="flex h-9 w-9 items-center justify-center rounded-lg bg-white shadow-sm ring-1 ring-slate-200/80 dark:bg-slate-700 dark:ring-slate-600">
                          <svg class="h-4.5 w-4.5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                          </svg>
                        </div>
                        <span class="text-[11px] font-semibold text-slate-700 dark:text-slate-200">Infographic</span>
                        <span *ngIf="infographicImageUrl" class="absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-emerald-500 text-[10px] font-bold text-white shadow">✓</span>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Expandable Content Panels -->
                <div *ngIf="studioActivePanel" class="border-t border-slate-100 dark:border-slate-800">

                  <!-- Export Panel -->
                  <div *ngIf="studioActivePanel === 'export'" class="p-5 space-y-4 animate-fadeIn">
                    <div class="flex items-center justify-between">
                      <p class="text-sm font-medium text-slate-700 dark:text-slate-200">
                        {{ 'playgroundSteps.finalReview.downloadDraft' | translate }}
                      </p>
                      <button (click)="studioActivePanel = null" class="p-1 rounded-md text-slate-400 hover:text-slate-600 hover:bg-slate-100 dark:hover:text-slate-300 dark:hover:bg-slate-800 transition">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                    <p class="text-xs text-slate-500 dark:text-slate-400">Save your current work in your preferred format</p>
                    <div class="grid grid-cols-2 gap-3">
                      <button
                        type="button"
                        (click)="downloadCurrentDraftPdf()"
                        [disabled]="!currentDraftText || downloadingDraftPdf"
                        class="flex items-center justify-center gap-2 rounded-lg border border-slate-200 bg-white px-4 py-3 text-sm font-medium text-slate-700 transition hover:bg-slate-50 hover:border-slate-300 disabled:opacity-50 disabled:cursor-not-allowed dark:border-slate-600 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700">
                        <ng-container *ngIf="!downloadingDraftPdf; else draftPdfLoading">
                          <svg class="h-4 w-4 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zm-3 9v4h-1v-4H8l2-2 2 2h-1zm6 0v4h-1v-4h-1l2-2 2 2h-1z"/>
                          </svg>
                          PDF
                        </ng-container>
                        <ng-template #draftPdfLoading>
                          <svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                          </svg>
                        </ng-template>
                      </button>
                      <button
                        type="button"
                        (click)="downloadCurrentDraftDocx()"
                        [disabled]="!currentDraftText || downloadingDraftDocx"
                        class="flex items-center justify-center gap-2 rounded-lg bg-slate-900 px-4 py-3 text-sm font-medium text-white transition hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed dark:bg-slate-700 dark:hover:bg-slate-600">
                        <ng-container *ngIf="!downloadingDraftDocx; else draftDocxLoading">
                          <svg class="h-4 w-4 text-blue-400" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zM9.5 13l1.5 6 1.5-6h1l1.5 6 1.5-6h1l-2 8h-1l-1.5-6-1.5 6h-1l-2-8h1z"/>
                          </svg>
                          Word
                        </ng-container>
                        <ng-template #draftDocxLoading>
                          <svg class="h-4 w-4 animate-spin text-white" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                          </svg>
                        </ng-template>
                      </button>
                    </div>
                  </div>

                  <!-- AI Feedback Panel -->
                  <div *ngIf="studioActivePanel === 'feedback'" class="p-5 space-y-4 animate-fadeIn">
                    <div class="flex items-center justify-between">
                      <p class="text-sm font-medium text-slate-700 dark:text-slate-200">
                        {{ 'playgroundSteps.finalReview.getAiFeedback' | translate }}
                      </p>
                      <button (click)="studioActivePanel = null" class="p-1 rounded-md text-slate-400 hover:text-slate-600 hover:bg-slate-100 dark:hover:text-slate-300 dark:hover:bg-slate-800 transition">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>

                    <!-- AI Selector -->
                    <div class="relative" #aiEvaluatorDropdownRef>
                      <button
                        type="button"
                        (click)="toggleAiEvaluatorDropdown()"
                        class="w-full flex items-center justify-between gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2.5 text-sm transition hover:border-slate-300 dark:border-slate-600 dark:bg-slate-800 dark:hover:border-slate-500">
                        <div class="flex items-center gap-2.5 min-w-0">
                          <img
                            [src]="selectedAiEvaluator.avatarPath"
                            [alt]="selectedAiEvaluator.name"
                            class="h-7 w-7 rounded-full object-cover ring-2 ring-slate-200 dark:ring-slate-600" />
                          <span class="truncate font-medium text-slate-700 dark:text-slate-200">{{ selectedAiEvaluator.name }}</span>
                        </div>
                        <svg class="h-4 w-4 text-slate-400 transition-transform" [class.rotate-180]="showAiEvaluatorDropdown" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m19 9-7 7-7-7" />
                        </svg>
                      </button>

                      <div *ngIf="showAiEvaluatorDropdown" class="absolute z-20 mt-1.5 w-full max-h-48 overflow-y-auto rounded-lg border border-slate-200 bg-white shadow-lg dark:border-slate-600 dark:bg-slate-800">
                        <button
                          *ngFor="let ai of aiEvaluatorOptions"
                          type="button"
                          (click)="selectAiEvaluator(ai)"
                          class="flex w-full items-center gap-2.5 px-3 py-2.5 text-left text-sm transition hover:bg-slate-50 dark:hover:bg-slate-700"
                          [ngClass]="{'bg-slate-50 dark:bg-slate-700/70': ai.collectionKey === selectedAiEvaluator.collectionKey}">
                          <img [src]="ai.avatarPath" [alt]="ai.name" class="h-7 w-7 rounded-full object-cover" />
                          <span class="truncate font-medium text-slate-700 dark:text-slate-200">{{ ai.name }}</span>
                          <svg *ngIf="ai.collectionKey === selectedAiEvaluator.collectionKey" class="ml-auto h-4 w-4 text-emerald-500" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m5 13 4 4L19 7" />
                          </svg>
                        </button>
                      </div>
                    </div>

                    <button
                      type="button"
                      (click)="requestAiFeedback()"
                      [disabled]="aiFeedbackLoading"
                      class="w-full flex items-center justify-center gap-2 rounded-lg px-4 py-3 text-sm font-semibold transition disabled:opacity-60 disabled:cursor-not-allowed"
                      [ngClass]="aiFeedbackText
                        ? 'bg-slate-100 text-slate-700 hover:bg-slate-200 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600'
                        : 'bg-gradient-to-r from-teal-500 to-emerald-500 text-white shadow-md shadow-teal-500/25 hover:from-teal-400 hover:to-emerald-400'">
                      <ng-container *ngIf="!aiFeedbackLoading; else feedbackLoading">
                        <svg *ngIf="aiFeedbackText" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        <svg *ngIf="!aiFeedbackText" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                        {{ aiFeedbackText ? ('playgroundSteps.finalReview.getAnotherAiFeedback' | translate) : ('playgroundSteps.finalReview.getAiFeedback' | translate) }}
                      </ng-container>
                      <ng-template #feedbackLoading>
                        <svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>{{ 'playgroundSteps.finalReview.reviewing' | translate }}</span>
                      </ng-template>
                    </button>

                    <p *ngIf="aiFeedbackStatus" class="text-xs text-center text-teal-600 dark:text-teal-400 animate-pulse">
                      {{ aiFeedbackStatus }}
                    </p>
                    <div *ngIf="aiFeedbackError" class="rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-xs text-red-700 dark:border-red-500/40 dark:bg-red-500/10 dark:text-red-300">
                      {{ aiFeedbackError }}
                    </div>

                    <!-- Human Feedback Invite -->
                    <div class="mt-4 rounded-2xl border border-slate-200 bg-gradient-to-br from-white via-slate-50 to-emerald-50 p-4 shadow-sm dark:border-slate-700 dark:from-slate-900 dark:via-slate-900 dark:to-emerald-950/40">
                      <button
                        type="button"
                        (click)="showHumanInvite = !showHumanInvite"
                        class="w-full flex items-center justify-between gap-3 text-left"
                      >
                        <div class="flex items-start gap-3">
                          <div class="h-9 w-9 flex items-center justify-center rounded-xl bg-emerald-100 text-emerald-600 dark:bg-emerald-900/50 dark:text-emerald-300">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207" />
                            </svg>
                          </div>
                          <div>
                            <p class="text-sm font-semibold text-slate-800 dark:text-slate-100">
                              Invite Human Feedback
                            </p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">
                              Add an evaluator to review your solution. They’ll receive the same evaluation page as in Solution Details.
                            </p>
                          </div>
                        </div>
                        <div class="flex items-center gap-2 text-xs font-medium text-emerald-600 dark:text-emerald-300">
                          <span *ngIf="currentSolution.evaluationDetails?.length" class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-0.5 text-[10px] font-semibold text-emerald-700 dark:bg-emerald-900/60 dark:text-emerald-200">
                            {{ currentSolution.evaluationDetails?.length }} feedback
                          </span>
                          <span>{{ showHumanInvite ? 'Show less' : 'Expand' }}</span>
                          <svg class="h-4 w-4 transition-transform" [class.rotate-180]="showHumanInvite" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m19 9-7 7-7-7" />
                          </svg>
                        </div>
                      </button>

                      <div *ngIf="showHumanInvite" class="mt-4 relative animate-fadeIn">
                        <label class="block text-xs font-semibold text-slate-600 dark:text-slate-300 mb-2">
                          Email or Name
                        </label>
                        <div class="relative">
                          <input
                            type="text"
                            [(ngModel)]="evaluatorInviteInput"
                            (input)="onEvaluatorInviteInputChange()"
                            (focus)="onEvaluatorInviteInputChange()"
                            (blur)="hideEvaluatorSuggestions()"
                            placeholder="evaluator@example.com"
                            class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 shadow-sm transition focus:border-emerald-400 focus:ring-2 focus:ring-emerald-200 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100 dark:focus:border-emerald-500 dark:focus:ring-emerald-900/40"
                          />
                          <div class="absolute inset-y-0 right-3 flex items-center">
                            <svg *ngIf="!isSearchingEvaluators" class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <svg *ngIf="isSearchingEvaluators" class="h-4 w-4 animate-spin text-emerald-500" fill="none" viewBox="0 0 24 24">
                              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                          </div>
                        </div>

                        <div
                          *ngIf="showEvaluatorSuggestions && evaluatorInviteSuggestions.length > 0"
                          class="absolute z-20 mt-2 w-full max-h-64 overflow-y-auto rounded-xl border border-slate-200 bg-white shadow-xl dark:border-slate-700 dark:bg-slate-800"
                        >
                          <button
                            *ngFor="let user of evaluatorInviteSuggestions"
                            type="button"
                            (mousedown)="selectEvaluatorSuggestion(user); $event.preventDefault()"
                            class="flex w-full items-center gap-3 px-4 py-3 text-left text-sm hover:bg-emerald-50 dark:hover:bg-emerald-900/30"
                          >
                            <div class="h-9 w-9 rounded-full bg-emerald-100 text-emerald-700 flex items-center justify-center font-semibold text-xs dark:bg-emerald-900/50 dark:text-emerald-200">
                              {{ getInitials(user.firstName, user.lastName, user.email) }}
                            </div>
                            <div class="min-w-0 flex-1">
                              <p class="font-semibold text-slate-800 dark:text-slate-100 truncate">
                                {{ user.firstName }} {{ user.lastName }}
                              </p>
                              <p class="text-xs text-slate-500 dark:text-slate-400 truncate">
                                {{ user.email }}
                              </p>
                            </div>
                            <svg class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                            </svg>
                          </button>
                        </div>
                      </div>

                      <div *ngIf="evaluatorInviteInput && canInviteEvaluator" class="mt-3 flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                        <span class="inline-flex h-2 w-2 rounded-full bg-emerald-400"></span>
                        <span>
                          {{ selectedEvaluatorUser ? 'Registered user found' : 'Email will be invited even if not registered' }}
                        </span>
                      </div>

                      <div class="mt-4 flex items-center gap-3">
                        <button
                          type="button"
                          (click)="inviteEvaluator()"
                          [disabled]="!canInviteEvaluator"
                          class="flex-1 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 px-4 py-2.5 text-sm font-semibold text-white shadow-md transition hover:from-emerald-400 hover:to-teal-400 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          <span *ngIf="!isInvitingEvaluator">Send Invite</span>
                          <span *ngIf="isInvitingEvaluator" class="flex items-center justify-center gap-2">
                            <svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Sending...
                          </span>
                        </button>
                      </div>

                      <p *ngIf="evaluatorInviteStatus" class="mt-3 text-xs font-medium text-emerald-600 dark:text-emerald-300">
                        {{ evaluatorInviteStatus }}
                      </p>
                      <p *ngIf="evaluatorInviteError" class="mt-3 text-xs font-medium text-red-600 dark:text-red-400">
                        {{ evaluatorInviteError }}
                      </p>

                      <div *ngIf="recentEvaluatorInvites.length > 0" class="mt-4 space-y-2">
                        <p class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide">
                          Recent Invites
                        </p>
                        <div
                          *ngFor="let invite of recentEvaluatorInvites.slice(0, 4)"
                          class="flex items-center justify-between rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs dark:border-slate-700 dark:bg-slate-800"
                        >
                          <div class="min-w-0">
                            <p class="font-semibold text-slate-700 dark:text-slate-200 truncate">
                              {{ invite.name }}
                            </p>
                            <p class="text-[11px] text-slate-500 dark:text-slate-400 truncate">
                              {{ invite.email }}
                            </p>
                          </div>
                          <span
                            [ngClass]="{
                              'text-emerald-600 dark:text-emerald-300': invite.status === 'success',
                              'text-amber-600 dark:text-amber-300': invite.status === 'exists',
                              'text-red-600 dark:text-red-400': invite.status === 'error'
                            }"
                            class="text-[11px] font-semibold"
                          >
                            {{ invite.status === 'success' ? 'Sent' : invite.status === 'exists' ? 'Exists' : 'Failed' }}
                          </span>
                        </div>
                      </div>

                      <div *ngIf="currentSolution.evaluationDetails?.length" class="mt-5 space-y-3">
                        <div class="flex items-center justify-between">
                          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">
                            Existing Feedback ({{ currentSolution.evaluationDetails?.length }})
                          </p>
                          <a
                            [routerLink]="['/evaluation-summary', currentSolution.solutionId]"
                            class="text-xs font-semibold text-emerald-600 hover:text-emerald-500 dark:text-emerald-300"
                          >
                            Open Summary
                          </a>
                        </div>
                        <div class="space-y-2">
                          <div
                            *ngFor="let ev of currentSolution.evaluationDetails; let i = index"
                            class="rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs shadow-sm dark:border-slate-700 dark:bg-slate-800"
                          >
                            <div class="flex items-start justify-between gap-3">
                              <div class="min-w-0">
                                <p class="font-semibold text-slate-700 dark:text-slate-200 truncate">
                                  {{ ev.evaluator?.firstName || ev.evaluator?.lastName ? (ev.evaluator?.firstName + ' ' + ev.evaluator?.lastName) : (ev.evaluator?.email || ('Evaluator #' + (i + 1))) }}
                                </p>
                                <p *ngIf="ev.comment" class="mt-1 text-[11px] text-slate-500 dark:text-slate-400">
                                  {{ ev.comment }}
                                </p>
                              </div>
                              <div class="flex flex-col items-end gap-2">
                                <span *ngIf="ev.average" class="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600 dark:bg-slate-700 dark:text-slate-200">
                                  Avg {{ ev.average }}/10
                                </span>
                                <a
                                  [routerLink]="['/evaluation-summary', currentSolution.solutionId]"
                                  class="text-[11px] font-semibold text-emerald-600 hover:text-emerald-500 dark:text-emerald-300"
                                >
                                  Open
                                </a>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Report Panel -->
                  <div *ngIf="studioActivePanel === 'report'" class="p-5 space-y-4 animate-fadeIn">
                    <div class="flex items-center justify-between">
                      <p class="text-sm font-medium text-slate-700 dark:text-slate-200">
                        {{ 'playgroundSteps.finalReview.generateReport' | translate }}
                      </p>
                      <button (click)="studioActivePanel = null" class="p-1 rounded-md text-slate-400 hover:text-slate-600 hover:bg-slate-100 dark:hover:text-slate-300 dark:hover:bg-slate-800 transition">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                    <p class="text-xs text-slate-500 dark:text-slate-400">
                      {{ 'playgroundSteps.finalReview.generateReportHint' | translate }}
                    </p>

                    <button
                      type="button"
                      (click)="openReportModal()"
                      [disabled]="reportLoading"
                      class="w-full flex items-center justify-center gap-2 rounded-lg bg-gradient-to-r from-teal-500 to-emerald-500 px-4 py-3 text-sm font-semibold text-white shadow-md shadow-teal-500/25 transition hover:from-teal-400 hover:to-emerald-400 disabled:opacity-60 disabled:cursor-not-allowed">
                      <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                      </svg>
                      {{ 'playgroundSteps.finalReview.generateReportButton' | translate }}
                    </button>

                    <div *ngIf="reportLoading" class="flex items-center gap-2 rounded-lg bg-slate-50 px-3 py-2.5 dark:bg-slate-800">
                      <svg class="h-4 w-4 animate-spin text-teal-600 dark:text-teal-400" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      <span class="text-xs font-medium text-slate-600 dark:text-slate-300">Generating...</span>
                    </div>

                    <div *ngIf="reportStatus && !reportLoading" class="rounded-lg bg-slate-50 px-3 py-2 text-xs font-medium text-slate-600 dark:bg-slate-800 dark:text-slate-300">
                      {{ reportStatus }}
                    </div>
                    <p *ngIf="reportError" class="text-xs font-medium text-red-600 dark:text-red-400">{{ reportError }}</p>

                    <!-- Report ready - download options -->
                    <div *ngIf="reportText" class="space-y-3 pt-2 border-t border-slate-100 dark:border-slate-800">
                      <div class="flex items-center gap-2">
                        <svg class="h-4 w-4 text-emerald-500" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-xs font-semibold text-slate-700 dark:text-slate-200">
                          {{ getSelectedReportType()?.title || ('playgroundSteps.finalReview.reportReady' | translate) }}
                        </p>
                      </div>
                      <div class="grid grid-cols-2 gap-2">
                        <button
                          type="button"
                          (click)="downloadReportPdf()"
                          [disabled]="downloadingReportPdf"
                          class="flex items-center justify-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2.5 text-xs font-medium text-slate-700 transition hover:bg-slate-50 disabled:opacity-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-200">
                          <ng-container *ngIf="!downloadingReportPdf; else reportPdfLoading">
                            <svg class="h-3.5 w-3.5 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zm-3 9v4h-1v-4H8l2-2 2 2h-1zm6 0v4h-1v-4h-1l2-2 2 2h-1z"/>
                            </svg>
                            PDF
                          </ng-container>
                          <ng-template #reportPdfLoading>
                            <svg class="h-3.5 w-3.5 animate-spin" fill="none" viewBox="0 0 24 24">
                              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                          </ng-template>
                        </button>
                        <button
                          type="button"
                          (click)="downloadReportDocx()"
                          [disabled]="downloadingReportDocx"
                          class="flex items-center justify-center gap-2 rounded-lg bg-slate-900 px-3 py-2.5 text-xs font-medium text-white transition hover:bg-slate-800 disabled:opacity-50 dark:bg-slate-700 dark:hover:bg-slate-600">
                          <ng-container *ngIf="!downloadingReportDocx; else reportDocxLoading">
                            <svg class="h-3.5 w-3.5 text-blue-400" fill="currentColor" viewBox="0 0 24 24">
                              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zM9.5 13l1.5 6 1.5-6h1l1.5 6 1.5-6h1l-2 8h-1l-1.5-6-1.5 6h-1l-2-8h1z"/>
                            </svg>
                            Word
                          </ng-container>
                          <ng-template #reportDocxLoading>
                            <svg class="h-3.5 w-3.5 animate-spin text-white" fill="none" viewBox="0 0 24 24">
                              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                          </ng-template>
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Infographic Panel -->
                  <div *ngIf="studioActivePanel === 'infographic'" class="p-5 space-y-4 animate-fadeIn">
                    <div class="flex items-center justify-between">
                      <p class="text-sm font-medium text-slate-700 dark:text-slate-200">
                        Create Infographic
                      </p>
                      <button (click)="studioActivePanel = null" class="p-1 rounded-md text-slate-400 hover:text-slate-600 hover:bg-slate-100 dark:hover:text-slate-300 dark:hover:bg-slate-800 transition">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                    <p class="text-xs text-slate-500 dark:text-slate-400">
                      Generate a beautiful visual summary of your strategy
                    </p>

                    <!-- Generate Button -->
                    <button
                      type="button"
                      (click)="generateInfographic()"
                      [disabled]="infographicLoading || !currentDraftText"
                      class="w-full flex items-center justify-center gap-2 rounded-lg bg-gradient-to-r from-teal-500 to-emerald-500 px-4 py-3 text-sm font-semibold text-white shadow-md shadow-teal-500/25 transition hover:from-teal-400 hover:to-emerald-400 disabled:opacity-60 disabled:cursor-not-allowed">
                      <ng-container *ngIf="!infographicLoading; else infographicLoadingTpl">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.395m3.42 3.42a15.995 15.995 0 004.764-4.648l3.876-5.814a1.151 1.151 0 00-1.597-1.597L14.146 6.32a15.996 15.996 0 00-4.649 4.763m3.42 3.42a6.776 6.776 0 00-3.42-3.42" />
                        </svg>
                        Generate Infographic
                      </ng-container>
                      <ng-template #infographicLoadingTpl>
                        <svg class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
                          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>{{ infographicStatus || 'Creating your infographic...' }}</span>
                      </ng-template>
                    </button>

                    <p *ngIf="infographicStatus && !infographicLoading" class="text-xs text-center text-teal-600 dark:text-teal-400">
                      {{ infographicStatus }}
                    </p>
                    <p *ngIf="infographicError" class="text-xs font-medium text-red-600 dark:text-red-400">{{ infographicError }}</p>
                  </div>
                </div>

                <!-- Results Section (AI Feedback - toggleable) -->
                <div *ngIf="aiFeedbackText" class="border-t border-slate-100 dark:border-slate-800">
                  <!-- Toggle Header -->
                  <button
                    type="button"
                    (click)="showFeedbackResults = !showFeedbackResults"
                    class="w-full flex items-center justify-between px-5 py-3 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                    <div class="flex items-center gap-3">
                      <img
                        [src]="selectedAiEvaluator.avatarPath"
                        [alt]="selectedAiEvaluator.name"
                        class="h-8 w-8 rounded-full object-cover ring-2 ring-teal-200 dark:ring-teal-600" />
                      <div class="text-left">
                        <p class="text-xs font-semibold text-slate-700 dark:text-slate-200">{{ 'playgroundSteps.finalReview.aiFeedback' | translate }}</p>
                        <p class="text-[10px] text-slate-500 dark:text-slate-400">{{ selectedAiEvaluator.name }}</p>
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs font-medium text-teal-600 dark:text-teal-400">{{ showFeedbackResults ? 'Hide' : 'Show' }}</span>
                      <svg
                        class="h-4 w-4 text-slate-400 transition-transform"
                        [class.rotate-180]="showFeedbackResults"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m19 9-7 7-7-7" />
                      </svg>
                    </div>
                  </button>

                  <!-- Expandable Content -->
                  <div *ngIf="showFeedbackResults" class="px-5 pb-5 animate-fadeIn">
                    <div class="rounded-xl border border-slate-200 bg-slate-50/50 p-4 dark:border-slate-700 dark:bg-slate-800/50">
                      <ng-container *ngIf="hasStructuredFeedback; else fallbackFeedbackCompact">
                        <div *ngIf="aiFeedbackParsed.scores.length" class="mb-4">
                          <div class="grid gap-2 sm:grid-cols-2">
                            <div
                              *ngFor="let score of aiFeedbackParsed.scores"
                              class="rounded-lg border border-slate-200 bg-white p-3 dark:border-slate-700 dark:bg-slate-800">
                              <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">{{ score.label }}</p>
                              <div class="flex items-baseline gap-1">
                                <span class="text-xl font-bold text-slate-900 dark:text-white">{{ score.scoreValue || '—' }}</span>
                                <span class="text-xs text-slate-500">/{{ score.scoreMax || '10' }}</span>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div *ngIf="aiFeedbackParsed.improvements.length" class="space-y-2">
                          <p class="text-[10px] font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                            {{ 'playgroundSteps.finalReview.improvements' | translate }}
                          </p>
                          <ul class="space-y-1.5">
                            <li
                              *ngFor="let tip of aiFeedbackParsed.improvements; let idx = index"
                              class="flex items-start gap-2 text-xs text-slate-600 dark:text-slate-300">
                              <span class="flex h-5 w-5 flex-shrink-0 items-center justify-center rounded-full bg-teal-100 text-[10px] font-semibold text-teal-700 dark:bg-teal-500/20 dark:text-teal-300">{{ idx + 1 }}</span>
                              <span>{{ tip }}</span>
                            </li>
                          </ul>
                        </div>

                        <div *ngIf="aiFeedbackParsed.readinessLevel" class="mt-4 rounded-lg bg-gradient-to-r from-teal-50 to-emerald-50 p-3 dark:from-teal-500/10 dark:to-emerald-500/10">
                          <p class="text-[10px] font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">{{ 'playgroundSteps.finalReview.readinessLevel' | translate }}</p>
                          <p class="text-lg font-bold text-teal-700 dark:text-teal-300">{{ aiFeedbackParsed.readinessLevel }}</p>
                        </div>
                      </ng-container>

                      <ng-template #fallbackFeedbackCompact>
                        <div class="text-xs leading-relaxed text-slate-700 dark:text-slate-300" [innerHTML]="aiFeedbackFormatted"></div>
                      </ng-template>

                      <div class="mt-4 pt-3 border-t border-slate-200 dark:border-slate-700">
                        <button
                          type="button"
                          (click)="downloadSolutionPdf()"
                          [disabled]="downloadingFeedbackPdf"
                          class="w-full flex items-center justify-center gap-2 rounded-lg bg-slate-900 px-4 py-2.5 text-xs font-semibold text-white transition hover:bg-slate-800 disabled:opacity-60 dark:bg-slate-700 dark:hover:bg-slate-600">
                          <ng-container *ngIf="!downloadingFeedbackPdf; else feedbackPdfLoading">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            {{ 'playgroundSteps.finalReview.downloadSolution' | translate }}
                          </ng-container>
                          <ng-template #feedbackPdfLoading>
                            <svg class="h-4 w-4 animate-spin text-white" fill="none" viewBox="0 0 24 24">
                              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Preparing...</span>
                          </ng-template>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Results Section (Infographic - toggleable) -->
                <div *ngIf="infographicImageUrl" class="border-t border-slate-100 dark:border-slate-800">
                  <!-- Toggle Header -->
                  <button
                    type="button"
                    (click)="showInfographicResults = !showInfographicResults"
                    class="w-full flex items-center justify-between px-5 py-3 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                    <div class="flex items-center gap-3">
                      <div class="flex h-8 w-8 items-center justify-center rounded-full bg-gradient-to-br from-teal-400 to-emerald-500 shadow">
                        <svg class="h-4 w-4 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                        </svg>
                      </div>
                      <div class="text-left">
                        <p class="text-xs font-semibold text-slate-700 dark:text-slate-200">Infographic</p>
                        <p class="text-[10px] text-slate-500 dark:text-slate-400">Visual summary of your strategy</p>
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-xs font-medium text-teal-600 dark:text-teal-400">{{ showInfographicResults ? 'Hide' : 'Show' }}</span>
                      <svg
                        class="h-4 w-4 text-slate-400 transition-transform"
                        [class.rotate-180]="showInfographicResults"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m19 9-7 7-7-7" />
                      </svg>
                    </div>
                  </button>

                  <!-- Expandable Content -->
                  <div *ngIf="showInfographicResults" class="px-5 pb-5 animate-fadeIn">
                    <div class="rounded-xl border border-slate-200 bg-slate-50/50 p-4 dark:border-slate-700 dark:bg-slate-800/50">
                      <!-- Infographic Image -->
                      <div class="relative overflow-hidden rounded-lg bg-white dark:bg-slate-900">
                        <img
                          [src]="infographicImageUrl"
                          alt="Strategy Infographic"
                          class="w-full h-auto object-contain max-h-96" />
                      </div>

                      <!-- Download Button -->
                      <div class="mt-4 pt-3 border-t border-slate-200 dark:border-slate-700">
                        <button
                          type="button"
                          (click)="downloadInfographic()"
                          [disabled]="downloadingInfographic"
                          class="w-full flex items-center justify-center gap-2 rounded-lg bg-slate-900 px-4 py-2.5 text-xs font-semibold text-white transition hover:bg-slate-800 disabled:opacity-60 dark:bg-slate-700 dark:hover:bg-slate-600">
                          <ng-container *ngIf="!downloadingInfographic; else infographicDownloadLoading">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Download Infographic
                          </ng-container>
                          <ng-template #infographicDownloadLoading>
                            <svg class="h-4 w-4 animate-spin text-white" fill="none" viewBox="0 0 24 24">
                              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Downloading...</span>
                          </ng-template>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- End Studio Panel -->

            </div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>

<div *ngIf="showReportModal" class="fixed inset-0 z-50 flex items-center justify-center px-4 pb-6 pt-24">
  <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" (click)="closeReportModal()"></div>
  <div class="relative w-full max-w-5xl rounded-3xl border border-white/60 bg-gradient-to-br from-white via-white to-emerald-50/70 p-6 shadow-[0_30px_90px_-40px_rgba(15,23,42,0.8)] dark:border-slate-800/60 dark:bg-gradient-to-br dark:from-slate-900 dark:via-slate-900 dark:to-emerald-900/20">
    <div class="flex items-start justify-between gap-4">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.2em] text-emerald-500">
          {{ 'playgroundSteps.finalReview.reportModal.badge' | translate }}
        </p>
        <h2 class="mt-2 text-2xl font-semibold text-slate-900 dark:text-white">
          {{ 'playgroundSteps.finalReview.reportModal.title' | translate }}
        </h2>
        <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">
          {{ 'playgroundSteps.finalReview.reportModal.subtitle' | translate }}
        </p>
      </div>
      <button
        type="button"
        (click)="closeReportModal()"
        class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-200 text-slate-500 transition hover:bg-slate-100 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800">
        ✕
      </button>
    </div>

    <div class="mt-6 max-h-[60vh] space-y-6 overflow-y-auto pr-2">
      <div *ngFor="let group of reportGroups"
        class="rounded-2xl border p-4 shadow-sm backdrop-blur"
        [ngClass]="group.id === 'funder'
          ? 'border-emerald-200/80 bg-emerald-50/70 dark:border-emerald-700/50 dark:bg-emerald-900/20'
          : 'border-slate-200/80 bg-white/70 dark:border-slate-700/80 dark:bg-slate-900/60'">
        <button
          type="button"
          (click)="toggleReportGroup(group.id)"
          class="flex w-full items-center justify-between gap-2 text-left">
          <div>
            <h3 class="text-sm font-semibold uppercase tracking-[0.18em]"
              [ngClass]="group.id === 'funder'
                ? 'text-emerald-700 dark:text-emerald-300'
                : 'text-slate-500 dark:text-slate-400'">
              {{ group.label }}
            </h3>
            <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">
              Choose a report tailored to this audience.
            </p>
          </div>
          <svg
            class="h-4 w-4 transition-transform"
            [ngClass]="group.id === 'funder' ? 'text-emerald-500' : 'text-slate-400'"
            [class.rotate-180]="reportGroupState[group.id]"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="m19 9-7 7-7-7" />
          </svg>
        </button>
        <div *ngIf="reportGroupState[group.id]" class="mt-3 grid gap-3 sm:grid-cols-2">
          <button
            *ngFor="let report of getReportsByGroup(group.id)"
            type="button"
            (click)="selectReportType(report)"
            class="group w-full rounded-2xl border p-4 text-left transition-all hover:-translate-y-0.5"
            [ngClass]="selectedReportTypeId === report.id
              ? (report.group === 'funder'
                  ? 'border-emerald-400 bg-emerald-50 shadow-lg shadow-emerald-100 dark:border-emerald-400/70 dark:bg-emerald-500/10'
                  : 'border-amber-400 bg-amber-50 shadow-lg shadow-amber-100 dark:border-amber-400/70 dark:bg-amber-500/10')
              : (report.group === 'funder'
                  ? 'border-emerald-200 bg-white hover:border-emerald-300 hover:bg-emerald-50/40 dark:border-emerald-700/50 dark:bg-slate-900/60 dark:hover:border-emerald-400/40'
                  : 'border-slate-200 bg-white hover:border-amber-200 hover:bg-amber-50/40 dark:border-slate-700 dark:bg-slate-900/60 dark:hover:border-amber-400/40')">
            <p class="text-sm font-semibold text-slate-900 dark:text-white">
              {{ report.title }}
            </p>
            <p class="mt-2 text-xs leading-relaxed text-slate-500 dark:text-slate-400">
              {{ report.summary || report.instruction }}
            </p>
          </button>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 dark:border-slate-700 dark:bg-slate-800/40">
        <label class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">
          {{ 'playgroundSteps.finalReview.reportModal.instructionLabel' | translate }}
        </label>
        <textarea
          [(ngModel)]="reportInstruction"
          rows="5"
          class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-100 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
        </textarea>
      </div>
    </div>

    <div class="mt-6 flex flex-col gap-3 sm:flex-row sm:justify-end">
      <button
        type="button"
        (click)="closeReportModal()"
        class="inline-flex items-center justify-center rounded-full border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100 dark:border-slate-600 dark:text-slate-200 dark:hover:bg-slate-800">
        {{ 'playgroundSteps.finalReview.reportModal.cancel' | translate }}
      </button>
      <button
        type="button"
        (click)="generateReport()"
        [disabled]="reportLoading"
        class="inline-flex items-center justify-center rounded-full bg-gradient-to-r from-emerald-500 to-teal-500 px-5 py-2 text-sm font-semibold text-white shadow-lg shadow-emerald-500/30 transition hover:from-emerald-400 hover:to-teal-400 disabled:cursor-not-allowed disabled:opacity-60">
        {{ 'playgroundSteps.finalReview.reportModal.generate' | translate }}
      </button>
    </div>
  </div>
</div>
