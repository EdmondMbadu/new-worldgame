<div class="dark:bg-slate-900 min-h-screen min-w-full">
    <!-- NAVBAR -->
    <app-navbar
      [sideBarSmall]="true"
      [sideBarBig]="false"
      [email]="auth.currentUser.email"
      [firstName]="auth.currentUser.firstName"
      [lastName]="auth.currentUser.lastName"
      path="home"
      current="">
    </app-navbar>
  
    <!-- TIMELINE / STEPS HEADER (centered) -->
    <!-- <div class="mt-20 container px-32 flex flex-row mx-auto justify-center">
      <ol class="items-center sm:flex">
        <li *ngFor="let step of steps; let i = index" class="relative mb-6 sm:mb-0">
          <div class="flex items-center">
            
            <div  
              (click)="goBackAndForthTimeLine(i)"
              
              class="z-10 flex items-center justify-center w-32 rounded-full shrink-0 cursor-pointer mt-4">
              
              <span
              [ngClass]="{'active': isCurrentStep(i)}"
                class="flex items-center justify-center w-16 h-16 border border-blue-600
                       rounded-full font-bold shrink-0 dark:border-blue-500 dark:text-white">
                {{ i + 1 }}
              </span>
              <div 
            *ngIf="i < steps.length-1 " 
            class="hidden sm:flex w-32 h-1 bg-gray-300 dark:bg-gray-700">
           
          </div>
          <div 
          *ngIf="i == steps.length-1 " 
          class="hidden sm:flex w-32 h-1 bg-white dark:bg-slate-900"></div>

            </div>
  
            
            <div class="hidden sm:flex w-full {{timelineDisplay[i]}} dark:bg-gray-700"></div>
          </div>
  
         
         
        </li>
      </ol>
    </div> -->
    <!-- TIMELINE / STEPS HEADER (centered) -->
<div class="mt-20 container px-32 flex flex-row mx-auto justify-center">
  <ol class="flex items-center space-x-0">
    <li *ngFor="let step of steps; let i = index" class="flex items-center relative">

      <!-- Line BEFORE image (touches image directly) -->
      <div 
        *ngIf="i !== 0"
        class="w-6 sm:w-24 h-1 transition-all duration-300"
        [ngClass]="isCurrentStep(i) ? 'bg-red-500' : 'bg-gray-300 dark:bg-gray-700'">
      </div>

      <!-- Step container (image + title, vertically stacked) -->
      <div class="flex flex-col items-center text-center">

        <!-- Image with red glow if current -->
        <div 
          (click)="goBackAndForthTimeLine(i)"
          class="z-10 flex items-center justify-center cursor-pointer transition-all duration-300"
          [ngClass]="isCurrentStep(i) ? 'ring-4 ring-red-500 rounded-full shadow-lg shadow-red-500/40' : ''">
          
          <img
            [src]="'../../../assets/img/step-' + (i + 1) + '.png'"
            alt="Step {{ i + 1 }} image"
            class="w-36 h-auto" />
        </div>

        <!-- Step title -->
        <div class="mt-2">
          <h1 class="text-lg font-semibold text-gray-800 dark:text-white">
           {{ step }}
          </h1>
        </div>

      </div>

    </li>
  </ol>
</div>






  
    <!-- MAIN CONTENT: Questions (left/center) + Image & Text (right) -->
    <div
      class="container px-10 mx-auto mt-10 flex flex-col-reverse lg:flex-row 
             justify-center items-center lg:items-start gap-8">
  
      <!-- LEFT/CENTER: Display the current step questions -->
      <div class="w-full lg:w-2/3">
        <!-- We only want one step visible at a time -->
        <ng-container *ngFor="let item of AllQuestions; let i = index">
          <app-playground-step
            *ngIf="display[i]"
            (submissionComplete)="sendRequestForEvaluation()"
            [title]="currentSolution.title"
            [step]="steps[i]"
            [questions]="AllQuestions[i]"
            [questionsTitles]="questionsTitles[i]"
            [stepNumber]="currentIndexDisplay"
            [buttonText]="buttontexts[i]"
            [solutionId]="id"
            (buttonInfoEvent)="updatePlayground($event)">
          </app-playground-step>
        </ng-container>
      </div>
  
      <!-- RIGHT: Step image + “subtitle” for whichever step is active -->
      <div class="w-full lg:w-1/3 flex flex-col items-center lg:items-start mt-10">
        <ng-container *ngFor="let step of steps; let i = index">
          <div *ngIf="display[i]" class="flex flex-col items-center lg:items-start">
            <!-- Step Image -->
            <img
              [src]="'../../../assets/img/step-' + (i + 1) + '.png'"
              alt="Step {{ i + 1 }} image"
              class="w-60 h-auto mb-3" />
  
            <!-- Step subtitle or fallback if only one question -->
            <time
              *ngIf="AllQuestions[i].length > 1"
              class="block mb-2 text-xl font-normal leading-none text-gray-500 dark:text-gray-400">
              {{ subtitles[i] }}
            </time>
            <div *ngIf="i === 1" class="mb-2 text-sm font-medium text-teal-700 dark:text-teal-300">
              <a
                [routerLink]="preferredStateGraphicUrl"
                class="underline hover:text-teal-600 dark:hover:text-teal-200">
                {{ currentLanguage === 'fr' ? "Graphique sur l'état souhaité" : 'Graphic on Preferred State' }}
              </a>
            </div>
            <time
              *ngIf="AllQuestions[i].length == 1"
              class="block mb-2 text-xl font-normal leading-none text-gray-500 dark:text-gray-400">
              {{ 'playgroundSteps.finalReview.title' | translate }}
            </time>
            <div *ngIf="isFinalStep(i)" class="w-full mt-4 space-y-3">
              <!-- AI Evaluator Selector -->
              <div class="relative" #aiEvaluatorDropdownRef>
                <button
                  type="button"
                  (click)="toggleAiEvaluatorDropdown()"
                  class="w-full flex items-center justify-between gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700">
                  <div class="flex items-center gap-2 min-w-0">
                    <img
                      [src]="selectedAiEvaluator.avatarPath"
                      [alt]="selectedAiEvaluator.name"
                      class="h-6 w-6 rounded-full object-cover ring-1 ring-slate-200 dark:ring-slate-600" />
                    <span class="truncate">{{ selectedAiEvaluator.name }}</span>
                  </div>
                  <svg
                    class="h-4 w-4 flex-shrink-0 text-slate-400 transition-transform"
                    [class.rotate-180]="showAiEvaluatorDropdown"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m19 9-7 7-7-7" />
                  </svg>
                </button>

                <!-- Dropdown Menu -->
                <div
                  *ngIf="showAiEvaluatorDropdown"
                  class="absolute z-20 mt-1 w-full max-h-48 overflow-y-auto rounded-xl border border-slate-200 bg-white shadow-lg dark:border-slate-600 dark:bg-slate-800">
                  <button
                    *ngFor="let ai of aiEvaluatorOptions"
                    type="button"
                    (click)="selectAiEvaluator(ai)"
                    class="flex w-full items-center gap-2 px-3 py-2 text-left text-sm transition hover:bg-slate-100 dark:hover:bg-slate-700"
                    [ngClass]="{'bg-teal-50 dark:bg-teal-900/30': ai.collectionKey === selectedAiEvaluator.collectionKey}">
                    <img
                      [src]="ai.avatarPath"
                      [alt]="ai.name"
                      class="h-6 w-6 rounded-full object-cover ring-1 ring-slate-200 dark:ring-slate-600" />
                    <span class="truncate text-slate-700 dark:text-slate-200">{{ ai.name }}</span>
                    <svg
                      *ngIf="ai.collectionKey === selectedAiEvaluator.collectionKey"
                      class="ml-auto h-4 w-4 flex-shrink-0 text-teal-600 dark:text-teal-400"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m5 13 4 4L19 7" />
                    </svg>
                  </button>
                </div>
              </div>

              <button
                type="button"
                (click)="requestAiFeedback()"
                [disabled]="aiFeedbackLoading"
                class="w-full inline-flex items-center justify-center rounded-2xl px-4 py-3 text-base font-semibold text-white shadow-lg transition disabled:cursor-not-allowed disabled:opacity-60"
                [ngClass]="aiFeedbackText ? 'bg-slate-600 shadow-slate-500/30 hover:bg-slate-500' : 'bg-teal-600 shadow-teal-500/40 hover:bg-teal-500'">
                <ng-container *ngIf="!aiFeedbackLoading; else feedbackLoading">
                  <ng-container *ngIf="aiFeedbackText; else firstFeedback">
                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    {{ 'playgroundSteps.finalReview.getAnotherAiFeedback' | translate }}
                  </ng-container>
                  <ng-template #firstFeedback>
                    {{ 'playgroundSteps.finalReview.getAiFeedback' | translate }}
                  </ng-template>
                </ng-container>
                <ng-template #feedbackLoading>
                  <span class="flex items-center gap-2">
                    <svg
                      class="h-4 w-4 animate-spin text-white"
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      aria-hidden="true">
                      <circle
                        class="opacity-25"
                        cx="12"
                        cy="12"
                        r="10"
                        stroke="currentColor"
                        stroke-width="4"></circle>
                      <path
                        class="opacity-75"
                        fill="currentColor"
                        d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 00-8 8h4z"></path>
                    </svg>
                    <span>{{ 'playgroundSteps.finalReview.reviewing' | translate }}</span>
                  </span>
                </ng-template>
              </button>

              <div class="w-full rounded-2xl border border-slate-200 bg-white/90 p-3 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">
                  {{ 'playgroundSteps.finalReview.downloadDraft' | translate }}
                </p>
                <div class="mt-2 grid grid-cols-2 gap-2">
                  <button
                    type="button"
                    (click)="downloadCurrentDraftPdf()"
                    [disabled]="!currentDraftText"
                    class="inline-flex items-center justify-center rounded-full border border-slate-300 px-3 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-600 dark:text-slate-200 dark:hover:bg-slate-800">
                    {{ 'playgroundSteps.finalReview.downloadDraftPdf' | translate }}
                  </button>
                  <button
                    type="button"
                    (click)="downloadCurrentDraftDocx()"
                    [disabled]="!currentDraftText"
                    class="inline-flex items-center justify-center rounded-full bg-slate-900 px-3 py-2 text-sm font-semibold text-white shadow-md transition hover:bg-slate-700 disabled:cursor-not-allowed disabled:opacity-50 dark:bg-slate-700 dark:hover:bg-slate-600">
                    {{ 'playgroundSteps.finalReview.downloadDraftDocx' | translate }}
                  </button>
                </div>
              </div>
              <p
                *ngIf="aiFeedbackStatus"
                class="text-sm text-gray-600 dark:text-gray-300">
                {{ aiFeedbackStatus }}
              </p>
              <div
                *ngIf="aiFeedbackError"
                class="rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-500/40 dark:bg-red-500/10 dark:text-red-200">
                {{ aiFeedbackError }}
              </div>
              <div
                *ngIf="aiFeedbackText"
                class="w-full rounded-3xl border border-emerald-200/60 bg-white/90 p-5 shadow-2xl shadow-emerald-500/20 backdrop-blur dark:border-teal-500/40 dark:bg-slate-900/70">
                <div class="mb-4 flex items-center gap-3">
                  <img
                    [src]="selectedAiEvaluator.avatarPath"
                    [alt]="selectedAiEvaluator.name"
                    class="h-10 w-10 rounded-full object-cover ring-2 ring-emerald-200 dark:ring-teal-500/40" />
                  <div>
                    <p class="text-xs font-semibold uppercase tracking-wide text-emerald-600 dark:text-emerald-300">{{ 'playgroundSteps.finalReview.evaluationBy' | translate: { name: selectedAiEvaluator.name } }}</p>
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white">{{ 'playgroundSteps.finalReview.aiFeedback' | translate }}</h3>
                  </div>
                </div>

                <ng-container *ngIf="hasStructuredFeedback; else fallbackFeedback">
                  <div *ngIf="aiFeedbackParsed.scores.length" class="mb-5 space-y-2">
                    <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-300">
                      {{ 'playgroundSteps.finalReview.scores' | translate }}
                    </p>
                    <div class="grid gap-3 sm:grid-cols-2">
                      <div
                        *ngFor="let score of aiFeedbackParsed.scores"
                        class="rounded-2xl border border-slate-100 bg-slate-50/80 p-4 dark:border-slate-700 dark:bg-slate-800/70">
                        <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-300">
                          {{ score.label }}
                        </p>
                        <div class="mt-1 flex items-baseline gap-1 text-slate-900 dark:text-white">
                          <span class="text-3xl font-bold">
                            {{ score.scoreValue || '—' }}
                          </span>
                          <span class="text-sm text-slate-500">
                            /{{ score.scoreMax || '10' }}
                          </span>
                        </div>
                        <p class="mt-2 text-sm text-slate-600 dark:text-slate-200">
                          {{ score.reason || score.raw }}
                        </p>
                      </div>
                    </div>
                  </div>

                  <div *ngIf="aiFeedbackParsed.improvements.length" class="mb-5 space-y-3">
                    <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-300">
                      {{ 'playgroundSteps.finalReview.improvements' | translate }}
                    </p>
                    <ul class="space-y-2">
                      <li
                        *ngFor="let tip of aiFeedbackParsed.improvements; let idx = index"
                        class="flex items-start gap-3 rounded-2xl border border-emerald-100/70 bg-emerald-50/60 p-3 dark:border-teal-500/30 dark:bg-teal-500/10">
                        <span
                          class="flex h-7 w-7 flex-shrink-0 items-center justify-center rounded-xl bg-white font-semibold text-emerald-600 shadow-sm dark:bg-slate-900 dark:text-teal-200">
                          {{ idx + 1 }}
                        </span>
                        <p class="text-sm text-slate-700 dark:text-slate-100">
                          {{ tip }}
                        </p>
                      </li>
                    </ul>
                  </div>

                  <div *ngIf="aiFeedbackParsed.readinessLevel" class="rounded-2xl border border-slate-200 bg-gradient-to-r from-emerald-50 to-cyan-50 p-4 dark:border-teal-500/30 dark:from-slate-800 dark:to-slate-900">
                    <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-300">
                      {{ 'playgroundSteps.finalReview.readinessLevel' | translate }}
                    </p>
                    <p class="mt-1 text-2xl font-bold text-slate-900 dark:text-white">
                      {{ aiFeedbackParsed.readinessLevel }}
                    </p>
                    <p
                      *ngIf="aiFeedbackParsed.readinessDetails"
                      class="mt-1 text-sm text-slate-600 dark:text-slate-200">
                      {{ aiFeedbackParsed.readinessDetails }}
                    </p>
                  </div>
                </ng-container>

                <ng-template #fallbackFeedback>
                  <div
                    class="text-sm leading-relaxed text-gray-800 dark:text-gray-100"
                    [innerHTML]="aiFeedbackFormatted">
                  </div>
                </ng-template>

                <!-- Download PDF Button -->
                <div class="mt-5 pt-4 border-t border-slate-200 dark:border-slate-700">
                  <button
                    type="button"
                    (click)="downloadSolutionPdf()"
                    class="w-full inline-flex items-center justify-center gap-2 rounded-xl bg-slate-800 px-4 py-2.5 text-sm font-semibold text-white shadow-md transition hover:bg-slate-700 dark:bg-slate-600 dark:hover:bg-slate-500">
                    <svg
                      class="h-5 w-5"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    {{ 'playgroundSteps.finalReview.downloadSolution' | translate }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
  
