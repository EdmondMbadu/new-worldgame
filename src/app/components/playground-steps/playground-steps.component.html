<div class="dark:bg-slate-900 min-h-screen min-w-full">
    <!-- NAVBAR -->
    <app-navbar
      [sideBarSmall]="true"
      [sideBarBig]="false"
      [email]="auth.currentUser.email"
      [firstName]="auth.currentUser.firstName"
      [lastName]="auth.currentUser.lastName"
      path="home"
      current="">
    </app-navbar>
  
    <!-- TIMELINE / STEPS HEADER (centered) -->
    <!-- <div class="mt-20 container px-32 flex flex-row mx-auto justify-center">
      <ol class="items-center sm:flex">
        <li *ngFor="let step of steps; let i = index" class="relative mb-6 sm:mb-0">
          <div class="flex items-center">
            
            <div  
              (click)="goBackAndForthTimeLine(i)"
              
              class="z-10 flex items-center justify-center w-32 rounded-full shrink-0 cursor-pointer mt-4">
              
              <span
              [ngClass]="{'active': isCurrentStep(i)}"
                class="flex items-center justify-center w-16 h-16 border border-blue-600
                       rounded-full font-bold shrink-0 dark:border-blue-500 dark:text-white">
                {{ i + 1 }}
              </span>
              <div 
            *ngIf="i < steps.length-1 " 
            class="hidden sm:flex w-32 h-1 bg-gray-300 dark:bg-gray-700">
           
          </div>
          <div 
          *ngIf="i == steps.length-1 " 
          class="hidden sm:flex w-32 h-1 bg-white dark:bg-slate-900"></div>

            </div>
  
            
            <div class="hidden sm:flex w-full {{timelineDisplay[i]}} dark:bg-gray-700"></div>
          </div>
  
         
         
        </li>
      </ol>
    </div> -->
    <!-- TIMELINE / STEPS HEADER (centered) -->
<div class="mt-20 container px-32 flex flex-row mx-auto justify-center">
  <ol class="flex items-center space-x-0">
    <li *ngFor="let step of steps; let i = index" class="flex items-center relative">

      <!-- Line BEFORE image (touches image directly) -->
      <div 
        *ngIf="i !== 0"
        class="w-6 sm:w-24 h-1 transition-all duration-300"
        [ngClass]="isCurrentStep(i) ? 'bg-red-500' : 'bg-gray-300 dark:bg-gray-700'">
      </div>

      <!-- Step container (image + title, vertically stacked) -->
      <div class="flex flex-col items-center text-center">

        <!-- Image with red glow if current -->
        <div 
          (click)="goBackAndForthTimeLine(i)"
          class="z-10 flex items-center justify-center cursor-pointer transition-all duration-300"
          [ngClass]="isCurrentStep(i) ? 'ring-4 ring-red-500 rounded-full shadow-lg shadow-red-500/40' : ''">
          
          <img
            [src]="'../../../assets/img/step-' + (i + 1) + '.png'"
            alt="Step {{ i + 1 }} image"
            class="w-36 h-auto" />
        </div>

        <!-- Step title -->
        <div class="mt-2">
          <h1 class="text-lg font-semibold text-gray-800 dark:text-white">
           {{ step }}
          </h1>
  </div>
</div>

    </li>
  </ol>
</div>






  
    <!-- MAIN CONTENT: Questions (left/center) + Image & Text (right) -->
    <div
      class="container px-10 mx-auto mt-10 flex flex-col-reverse lg:flex-row 
             justify-center items-center lg:items-start gap-8">
  
      <!-- LEFT/CENTER: Display the current step questions -->
      <div class="w-full lg:w-2/3">
        <!-- We only want one step visible at a time -->
        <ng-container *ngFor="let item of AllQuestions; let i = index">
          <app-playground-step
            *ngIf="display[i]"
            (submissionComplete)="sendRequestForEvaluation()"
            [title]="currentSolution.title"
            [step]="steps[i]"
            [questions]="AllQuestions[i]"
            [questionsTitles]="questionsTitles[i]"
            [stepNumber]="currentIndexDisplay"
            [buttonText]="buttontexts[i]"
            [solutionId]="id"
            (buttonInfoEvent)="updatePlayground($event)">
          </app-playground-step>
        </ng-container>
      </div>
  
      <!-- RIGHT: Step image + “subtitle” for whichever step is active -->
      <div class="w-full lg:w-1/3 flex flex-col items-center lg:items-start mt-10">
        <ng-container *ngFor="let step of steps; let i = index">
          <div *ngIf="display[i]" class="flex flex-col items-center lg:items-start">
            <!-- Step Image -->
            <img
              [src]="'../../../assets/img/step-' + (i + 1) + '.png'"
              alt="Step {{ i + 1 }} image"
              class="w-60 h-auto mb-3" />
  
            <!-- Step subtitle or fallback if only one question -->
            <time
              *ngIf="AllQuestions[i].length > 1"
              class="block mb-2 text-xl font-normal leading-none text-gray-500 dark:text-gray-400">
              {{ subtitles[i] }}
            </time>
            <div *ngIf="i === 1" class="mb-2 text-sm font-medium text-teal-700 dark:text-teal-300">
              <a
                [routerLink]="preferredStateGraphicUrl"
                class="underline hover:text-teal-600 dark:hover:text-teal-200">
                {{ currentLanguage === 'fr' ? "Graphique sur l'état souhaité" : 'Graphic on Preferred State' }}
              </a>
            </div>
            <time
              *ngIf="AllQuestions[i].length == 1"
              class="block mb-2 text-xl font-normal leading-none text-gray-500 dark:text-gray-400">
              {{ 'playgroundSteps.finalReview.title' | translate }}
            </time>
            <div *ngIf="isFinalStep(i)" class="w-full mt-4 space-y-4">

              <!-- SECTION 1: Download Current Draft -->
              <div class="w-full rounded-2xl border border-slate-200/80 bg-gradient-to-br from-white to-slate-50/80 p-5 shadow-sm transition-all hover:shadow-md dark:border-slate-700 dark:from-slate-900/80 dark:to-slate-800/60">
                <div class="flex items-center gap-3 mb-4">
                  <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-slate-100 dark:bg-slate-800">
                    <svg class="h-5 w-5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                  </div>
                  <div>
                    <p class="text-sm font-semibold text-slate-800 dark:text-white">
                      {{ 'playgroundSteps.finalReview.downloadDraft' | translate }}
                    </p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">Save your current work as PDF or Word</p>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <button
                    type="button"
                    (click)="downloadCurrentDraftPdf()"
                    [disabled]="!currentDraftText || downloadingDraftPdf"
                    class="group relative inline-flex items-center justify-center rounded-xl border-2 border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-700 transition-all hover:border-slate-300 hover:bg-slate-50 hover:shadow-sm disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-200 dark:hover:border-slate-500 dark:hover:bg-slate-700">
                    <ng-container *ngIf="!downloadingDraftPdf; else draftPdfLoading">
                      <svg class="mr-2 h-4 w-4 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zm-3 9v4h-1v-4H8l2-2 2 2h-1zm6 0v4h-1v-4h-1l2-2 2 2h-1z"/>
                      </svg>
                      PDF
                    </ng-container>
                    <ng-template #draftPdfLoading>
                      <svg class="h-4 w-4 animate-spin text-slate-600 dark:text-slate-300" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                    </ng-template>
                  </button>
                  <button
                    type="button"
                    (click)="downloadCurrentDraftDocx()"
                    [disabled]="!currentDraftText || downloadingDraftDocx"
                    class="group relative inline-flex items-center justify-center rounded-xl bg-gradient-to-r from-slate-800 to-slate-900 px-4 py-3 text-sm font-semibold text-white shadow-md shadow-slate-900/20 transition-all hover:from-slate-700 hover:to-slate-800 hover:shadow-lg disabled:cursor-not-allowed disabled:opacity-50 dark:from-slate-700 dark:to-slate-800 dark:shadow-slate-900/40 dark:hover:from-slate-600 dark:hover:to-slate-700">
                    <ng-container *ngIf="!downloadingDraftDocx; else draftDocxLoading">
                      <svg class="mr-2 h-4 w-4 text-blue-400" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zM9.5 13l1.5 6 1.5-6h1l1.5 6 1.5-6h1l-2 8h-1l-1.5-6-1.5 6h-1l-2-8h1z"/>
                      </svg>
                      Word
                    </ng-container>
                    <ng-template #draftDocxLoading>
                      <svg class="h-4 w-4 animate-spin text-white" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                    </ng-template>
                  </button>
                </div>
              </div>

              <!-- SECTION 2: AI Feedback -->
              <div class="w-full rounded-2xl border border-teal-200/60 bg-gradient-to-br from-teal-50/50 to-emerald-50/30 p-5 shadow-sm transition-all hover:shadow-md dark:border-teal-700/40 dark:from-slate-900/80 dark:to-teal-900/20">
                <div class="flex items-center gap-3 mb-4">
                  <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-teal-100 dark:bg-teal-900/50">
                    <svg class="h-5 w-5 text-teal-600 dark:text-teal-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                  </div>
                  <div>
                    <p class="text-sm font-semibold text-slate-800 dark:text-white">
                      {{ 'playgroundSteps.finalReview.getAiFeedback' | translate }}
                    </p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">Get expert evaluation from AI advisors</p>
                  </div>
                </div>

                <!-- AI Evaluator Selector -->
                <div class="relative mb-3" #aiEvaluatorDropdownRef>
                  <button
                    type="button"
                    (click)="toggleAiEvaluatorDropdown()"
                    class="w-full flex items-center justify-between gap-2 rounded-xl border border-teal-200 bg-white px-4 py-3 text-sm font-medium text-slate-700 shadow-sm transition hover:border-teal-300 hover:bg-teal-50/50 dark:border-teal-700 dark:bg-slate-800 dark:text-slate-200 dark:hover:border-teal-600 dark:hover:bg-slate-700">
                    <div class="flex items-center gap-3 min-w-0">
                      <img
                        [src]="selectedAiEvaluator.avatarPath"
                        [alt]="selectedAiEvaluator.name"
                        class="h-8 w-8 rounded-full object-cover ring-2 ring-teal-200 dark:ring-teal-600" />
                      <span class="truncate font-semibold">{{ selectedAiEvaluator.name }}</span>
                    </div>
                    <svg
                      class="h-5 w-5 flex-shrink-0 text-teal-500 transition-transform"
                      [class.rotate-180]="showAiEvaluatorDropdown"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m19 9-7 7-7-7" />
                    </svg>
                  </button>

                  <!-- Dropdown Menu -->
                  <div
                    *ngIf="showAiEvaluatorDropdown"
                    class="absolute z-20 mt-2 w-full max-h-56 overflow-y-auto rounded-xl border border-teal-200 bg-white shadow-xl dark:border-teal-700 dark:bg-slate-800">
                    <button
                      *ngFor="let ai of aiEvaluatorOptions"
                      type="button"
                      (click)="selectAiEvaluator(ai)"
                      class="flex w-full items-center gap-3 px-4 py-3 text-left text-sm transition hover:bg-teal-50 dark:hover:bg-slate-700"
                      [ngClass]="{'bg-teal-50 dark:bg-teal-900/30': ai.collectionKey === selectedAiEvaluator.collectionKey}">
                      <img
                        [src]="ai.avatarPath"
                        [alt]="ai.name"
                        class="h-8 w-8 rounded-full object-cover ring-1 ring-slate-200 dark:ring-slate-600" />
                      <span class="truncate font-medium text-slate-700 dark:text-slate-200">{{ ai.name }}</span>
                      <svg
                        *ngIf="ai.collectionKey === selectedAiEvaluator.collectionKey"
                        class="ml-auto h-5 w-5 flex-shrink-0 text-teal-600 dark:text-teal-400"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m5 13 4 4L19 7" />
                      </svg>
                    </button>
                  </div>
                </div>

                <button
                  type="button"
                  (click)="requestAiFeedback()"
                  [disabled]="aiFeedbackLoading"
                  class="w-full inline-flex items-center justify-center rounded-xl px-4 py-3.5 text-base font-semibold text-white shadow-lg transition-all disabled:cursor-not-allowed disabled:opacity-60"
                  [ngClass]="aiFeedbackText
                    ? 'bg-gradient-to-r from-slate-600 to-slate-700 shadow-slate-500/30 hover:from-slate-500 hover:to-slate-600'
                    : 'bg-gradient-to-r from-teal-500 to-emerald-500 shadow-teal-500/40 hover:from-teal-400 hover:to-emerald-400'">
                  <ng-container *ngIf="!aiFeedbackLoading; else feedbackLoading">
                    <ng-container *ngIf="aiFeedbackText; else firstFeedback">
                      <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                      </svg>
                      {{ 'playgroundSteps.finalReview.getAnotherAiFeedback' | translate }}
                    </ng-container>
                    <ng-template #firstFeedback>
                      <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                      </svg>
                      {{ 'playgroundSteps.finalReview.getAiFeedback' | translate }}
                    </ng-template>
                  </ng-container>
                  <ng-template #feedbackLoading>
                    <span class="flex items-center gap-3">
                      <svg class="h-5 w-5 animate-spin text-white" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      <span>{{ 'playgroundSteps.finalReview.reviewing' | translate }}</span>
                    </span>
                  </ng-template>
                </button>

                <p
                  *ngIf="aiFeedbackStatus"
                  class="mt-3 text-sm text-center text-teal-700 dark:text-teal-300 animate-pulse">
                  {{ aiFeedbackStatus }}
                </p>
                <div
                  *ngIf="aiFeedbackError"
                  class="mt-3 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-500/40 dark:bg-red-500/10 dark:text-red-200">
                  {{ aiFeedbackError }}
                </div>
              </div>

              <!-- AI Feedback Results (shown when feedback is available) -->
              <div
                *ngIf="aiFeedbackText"
                class="w-full rounded-3xl border border-emerald-200/60 bg-gradient-to-br from-white to-emerald-50/30 p-6 shadow-xl shadow-emerald-500/10 backdrop-blur transition-all dark:border-teal-500/40 dark:from-slate-900/90 dark:to-teal-900/20">
                <div class="mb-5 flex items-center gap-4">
                  <img
                    [src]="selectedAiEvaluator.avatarPath"
                    [alt]="selectedAiEvaluator.name"
                    class="h-12 w-12 rounded-full object-cover ring-3 ring-emerald-200 shadow-lg dark:ring-teal-500/40" />
                  <div>
                    <p class="text-xs font-semibold uppercase tracking-wider text-emerald-600 dark:text-emerald-300">{{ 'playgroundSteps.finalReview.evaluationBy' | translate: { name: selectedAiEvaluator.name } }}</p>
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white">{{ 'playgroundSteps.finalReview.aiFeedback' | translate }}</h3>
                  </div>
                </div>

                <ng-container *ngIf="hasStructuredFeedback; else fallbackFeedback">
                  <div *ngIf="aiFeedbackParsed.scores.length" class="mb-5 space-y-3">
                    <p class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-300">
                      {{ 'playgroundSteps.finalReview.scores' | translate }}
                    </p>
                    <div class="grid gap-3 sm:grid-cols-2">
                      <div
                        *ngFor="let score of aiFeedbackParsed.scores"
                        class="rounded-2xl border border-slate-100 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800/70">
                        <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-300">
                          {{ score.label }}
                        </p>
                        <div class="mt-1 flex items-baseline gap-1 text-slate-900 dark:text-white">
                          <span class="text-3xl font-bold">
                            {{ score.scoreValue || '—' }}
                          </span>
                          <span class="text-sm text-slate-500">
                            /{{ score.scoreMax || '10' }}
                          </span>
                        </div>
                        <p class="mt-2 text-sm text-slate-600 dark:text-slate-200">
                          {{ score.reason || score.raw }}
                        </p>
                      </div>
                    </div>
                  </div>

                  <div *ngIf="aiFeedbackParsed.improvements.length" class="mb-5 space-y-3">
                    <p class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-300">
                      {{ 'playgroundSteps.finalReview.improvements' | translate }}
                    </p>
                    <ul class="space-y-2">
                      <li
                        *ngFor="let tip of aiFeedbackParsed.improvements; let idx = index"
                        class="flex items-start gap-3 rounded-2xl border border-emerald-100/70 bg-emerald-50/60 p-4 dark:border-teal-500/30 dark:bg-teal-500/10">
                        <span
                          class="flex h-7 w-7 flex-shrink-0 items-center justify-center rounded-full bg-emerald-500 font-semibold text-white text-sm shadow-sm dark:bg-teal-600">
                          {{ idx + 1 }}
                        </span>
                        <p class="text-sm text-slate-700 dark:text-slate-100">
                          {{ tip }}
                        </p>
                      </li>
                    </ul>
                  </div>

                  <div *ngIf="aiFeedbackParsed.readinessLevel" class="rounded-2xl border border-emerald-200 bg-gradient-to-r from-emerald-50 to-teal-50 p-5 dark:border-teal-500/30 dark:from-slate-800 dark:to-teal-900/30">
                    <p class="text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-300">
                      {{ 'playgroundSteps.finalReview.readinessLevel' | translate }}
                    </p>
                    <p class="mt-1 text-2xl font-bold text-emerald-700 dark:text-emerald-300">
                      {{ aiFeedbackParsed.readinessLevel }}
                    </p>
                    <p
                      *ngIf="aiFeedbackParsed.readinessDetails"
                      class="mt-2 text-sm text-slate-600 dark:text-slate-200">
                      {{ aiFeedbackParsed.readinessDetails }}
                    </p>
                  </div>
                </ng-container>

                <ng-template #fallbackFeedback>
                  <div
                    class="text-sm leading-relaxed text-gray-800 dark:text-gray-100"
                    [innerHTML]="aiFeedbackFormatted">
                  </div>
                </ng-template>

                <!-- Download Feedback Button -->
                <div class="mt-5 pt-5 border-t border-emerald-200/60 dark:border-teal-700/40">
                  <button
                    type="button"
                    (click)="downloadSolutionPdf()"
                    [disabled]="downloadingFeedbackPdf"
                    class="w-full inline-flex items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-slate-700 to-slate-800 px-4 py-3 text-sm font-semibold text-white shadow-md transition-all hover:from-slate-600 hover:to-slate-700 disabled:cursor-not-allowed disabled:opacity-60 dark:from-slate-600 dark:to-slate-700 dark:hover:from-slate-500 dark:hover:to-slate-600">
                    <ng-container *ngIf="!downloadingFeedbackPdf; else feedbackPdfLoading">
                      <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                      {{ 'playgroundSteps.finalReview.downloadSolution' | translate }}
                    </ng-container>
                    <ng-template #feedbackPdfLoading>
                      <svg class="h-5 w-5 animate-spin text-white" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      <span>Preparing...</span>
                    </ng-template>
                  </button>
                </div>
              </div>

              <!-- SECTION 3: Generate Report -->
              <div class="w-full rounded-2xl border border-amber-200/60 bg-gradient-to-br from-amber-50/50 to-orange-50/30 p-5 shadow-sm transition-all hover:shadow-md dark:border-amber-700/40 dark:from-slate-900/80 dark:to-amber-900/20">
                <div class="flex items-center gap-3 mb-4">
                  <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-amber-100 dark:bg-amber-900/50">
                    <svg class="h-5 w-5 text-amber-600 dark:text-amber-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                  </div>
                  <div class="flex-1">
                    <p class="text-sm font-semibold text-slate-800 dark:text-white">
                      {{ 'playgroundSteps.finalReview.generateReport' | translate }}
                    </p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">
                      {{ 'playgroundSteps.finalReview.generateReportHint' | translate }}
                    </p>
                  </div>
                  <button
                    type="button"
                    (click)="openReportModal()"
                    class="inline-flex items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-amber-500/30 transition-all hover:from-amber-400 hover:to-orange-400 hover:shadow-xl">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                    </svg>
                    {{ 'playgroundSteps.finalReview.generateReportButton' | translate }}
                  </button>
                </div>

                <div *ngIf="reportLoading" class="flex items-center gap-3 rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 dark:border-amber-700/40 dark:bg-amber-900/30">
                  <svg class="h-5 w-5 animate-spin text-amber-600 dark:text-amber-400" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  <span class="text-sm font-medium text-amber-700 dark:text-amber-300">Generating your report...</span>
                </div>

                <div *ngIf="reportStatus && !reportLoading" class="rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm font-medium text-amber-700 dark:border-amber-700/40 dark:bg-amber-900/30 dark:text-amber-200">
                  {{ reportStatus }}
                </div>
                <p *ngIf="reportError" class="mt-3 text-sm font-medium text-red-600 dark:text-red-300">
                  {{ reportError }}
                </p>

                <div *ngIf="reportText" class="mt-4 space-y-4">
                  <div class="flex items-center gap-2">
                    <svg class="h-5 w-5 text-emerald-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="text-sm font-semibold text-slate-700 dark:text-slate-200">
                      {{ getSelectedReportType()?.title || ('playgroundSteps.finalReview.reportReady' | translate) }}
                    </p>
                  </div>
                  <div class="grid grid-cols-2 gap-3">
                    <button
                      type="button"
                      (click)="downloadReportPdf()"
                      [disabled]="downloadingReportPdf"
                      class="group relative inline-flex items-center justify-center rounded-xl border-2 border-amber-200 bg-white px-4 py-3 text-sm font-semibold text-slate-700 transition-all hover:border-amber-300 hover:bg-amber-50 disabled:cursor-not-allowed disabled:opacity-50 dark:border-amber-700 dark:bg-slate-800 dark:text-slate-200 dark:hover:border-amber-600 dark:hover:bg-slate-700">
                      <ng-container *ngIf="!downloadingReportPdf; else reportPdfLoading">
                        <svg class="mr-2 h-4 w-4 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zm-3 9v4h-1v-4H8l2-2 2 2h-1zm6 0v4h-1v-4h-1l2-2 2 2h-1z"/>
                        </svg>
                        PDF
                      </ng-container>
                      <ng-template #reportPdfLoading>
                        <svg class="h-4 w-4 animate-spin text-amber-600" fill="none" viewBox="0 0 24 24">
                          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                      </ng-template>
                    </button>
                    <button
                      type="button"
                      (click)="downloadReportDocx()"
                      [disabled]="downloadingReportDocx"
                      class="group relative inline-flex items-center justify-center rounded-xl bg-gradient-to-r from-amber-600 to-orange-600 px-4 py-3 text-sm font-semibold text-white shadow-md shadow-amber-600/20 transition-all hover:from-amber-500 hover:to-orange-500 hover:shadow-lg disabled:cursor-not-allowed disabled:opacity-50 dark:from-amber-700 dark:to-orange-700 dark:hover:from-amber-600 dark:hover:to-orange-600">
                      <ng-container *ngIf="!downloadingReportDocx; else reportDocxLoading">
                        <svg class="mr-2 h-4 w-4 text-blue-200" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zM9.5 13l1.5 6 1.5-6h1l1.5 6 1.5-6h1l-2 8h-1l-1.5-6-1.5 6h-1l-2-8h1z"/>
                        </svg>
                        Word
                      </ng-container>
                      <ng-template #reportDocxLoading>
                        <svg class="h-4 w-4 animate-spin text-white" fill="none" viewBox="0 0 24 24">
                          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                      </ng-template>
                    </button>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>

<div *ngIf="showReportModal" class="fixed inset-0 z-50 flex items-center justify-center px-4 pb-6 pt-24">
  <div class="absolute inset-0 bg-slate-900/60" (click)="closeReportModal()"></div>
  <div class="relative w-full max-w-5xl rounded-3xl bg-white p-6 shadow-2xl dark:bg-slate-900">
    <div class="flex items-start justify-between gap-4">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.2em] text-emerald-500">
          {{ 'playgroundSteps.finalReview.reportModal.badge' | translate }}
        </p>
        <h2 class="mt-2 text-2xl font-semibold text-slate-900 dark:text-white">
          {{ 'playgroundSteps.finalReview.reportModal.title' | translate }}
        </h2>
        <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">
          {{ 'playgroundSteps.finalReview.reportModal.subtitle' | translate }}
        </p>
      </div>
      <button
        type="button"
        (click)="closeReportModal()"
        class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-200 text-slate-500 transition hover:bg-slate-100 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800">
        ✕
      </button>
    </div>

    <div class="mt-6 max-h-[60vh] space-y-6 overflow-y-auto pr-2">
      <div *ngFor="let group of reportGroups"
        class="rounded-2xl border p-3"
        [ngClass]="group.id === 'strategy'
          ? 'border-emerald-200 bg-emerald-50/50 dark:border-emerald-700/50 dark:bg-emerald-900/20'
          : 'border-slate-200 bg-white/80 dark:border-slate-700 dark:bg-slate-900/60'">
        <button
          type="button"
          (click)="toggleReportGroup(group.id)"
          class="flex w-full items-center justify-between gap-2 text-left">
          <h3 class="text-sm font-semibold uppercase tracking-wide"
            [ngClass]="group.id === 'strategy'
              ? 'text-emerald-600 dark:text-emerald-400'
              : 'text-slate-500 dark:text-slate-400'">
            {{ group.label }}
          </h3>
          <svg
            class="h-4 w-4 transition-transform"
            [ngClass]="group.id === 'strategy' ? 'text-emerald-500' : 'text-slate-400'"
            [class.rotate-180]="reportGroupState[group.id]"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="m19 9-7 7-7-7" />
          </svg>
        </button>
        <div *ngIf="reportGroupState[group.id]" class="mt-3 grid gap-3 sm:grid-cols-2">
          <button
            *ngFor="let report of getReportsByGroup(group.id)"
            type="button"
            (click)="selectReportType(report)"
            class="w-full rounded-2xl border p-4 text-left transition"
            [ngClass]="selectedReportTypeId === report.id
              ? (report.group === 'strategy'
                  ? 'border-emerald-400 bg-emerald-50 shadow-lg shadow-emerald-100 dark:border-emerald-400/70 dark:bg-emerald-500/10'
                  : 'border-amber-400 bg-amber-50 shadow-lg shadow-amber-100 dark:border-amber-400/70 dark:bg-amber-500/10')
              : (report.group === 'strategy'
                  ? 'border-emerald-200 bg-white hover:border-emerald-300 hover:bg-emerald-50/40 dark:border-emerald-700/50 dark:bg-slate-900/60 dark:hover:border-emerald-400/40'
                  : 'border-slate-200 bg-white hover:border-amber-200 hover:bg-amber-50/40 dark:border-slate-700 dark:bg-slate-900/60 dark:hover:border-amber-400/40')">
            <p class="text-sm font-semibold text-slate-900 dark:text-white">
              {{ report.title }}
            </p>
            <p class="mt-2 text-xs leading-relaxed text-slate-500 dark:text-slate-400">
              {{ report.instruction }}
            </p>
          </button>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 dark:border-slate-700 dark:bg-slate-800/40">
        <label class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">
          {{ 'playgroundSteps.finalReview.reportModal.instructionLabel' | translate }}
        </label>
        <textarea
          [(ngModel)]="reportInstruction"
          rows="5"
          class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-100 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
        </textarea>
      </div>
    </div>

    <div class="mt-6 flex flex-col gap-3 sm:flex-row sm:justify-end">
      <button
        type="button"
        (click)="closeReportModal()"
        class="inline-flex items-center justify-center rounded-full border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-100 dark:border-slate-600 dark:text-slate-200 dark:hover:bg-slate-800">
        {{ 'playgroundSteps.finalReview.reportModal.cancel' | translate }}
      </button>
      <button
        type="button"
        (click)="generateReport()"
        [disabled]="reportLoading"
        class="inline-flex items-center justify-center rounded-full bg-gradient-to-r from-emerald-500 to-teal-500 px-5 py-2 text-sm font-semibold text-white shadow-lg shadow-emerald-500/30 transition hover:from-emerald-400 hover:to-teal-400 disabled:cursor-not-allowed disabled:opacity-60">
        {{ 'playgroundSteps.finalReview.reportModal.generate' | translate }}
      </button>
    </div>
  </div>
</div>
