<app-navbar
  [sideBarSmall]="true"
  [sideBarBig]="false"
  [email]="auth.currentUser?.email"
  [firstName]="auth.currentUser?.firstName"
  [lastName]="auth.currentUser?.lastName"
  [path]="'home'"
  current="''">
</app-navbar>

<div class="min-h-screen dark:bg-slate-950">
  <!-- ambient glow -->
  <div aria-hidden="true"
       class="pointer-events-none fixed -top-24 -left-24 hidden md:block h-80 w-80 rounded-full
              bg-gradient-to-tr from-violet-500 to-sky-400 opacity-20 blur-3xl"></div>
  <div aria-hidden="true"
       class="pointer-events-none fixed -bottom-28 -right-28 hidden md:block h-[28rem] w-[28rem] rounded-full
              bg-gradient-to-tr from-teal-500 to-emerald-400 opacity-20 blur-3xl"></div>

  <!-- widened container -->
  <div class="mx-auto max-w-7xl px-6 pt-24 pb-10">
    <!-- PROFILE HEADER -->
    <section
      class="relative isolate overflow-visible rounded-3xl border border-slate-200/70 bg-white/70 shadow-xl
             backdrop-blur dark:border-slate-800 dark:bg-slate-900/70">
      <div class="h-28 bg-gradient-to-r from-violet-500/20 via-sky-500/20 to-teal-500/20
                  dark:from-violet-500/15 dark:via-sky-500/15 dark:to-teal-500/15"></div>

      <div class="-mt-12 px-6 pb-6 sm:px-8">
        <div class="flex flex-col gap-6 md:flex-row md:items-center">
          <!-- AVATAR + DROPZONE -->
          <div class="relative shrink-0"
               appDropZone
               (hovered)="toggleHover($event)"
               (dropped)="startUpload($event)"
               [class.hovering]="isHovering">

            <input type="file" id="getFile" style="display:none"
                   (change)="startUpload($any($event.target).files)">

            <!-- exclusive avatar modes -->
            <ng-container *ngIf="avatarMode === 'initials'; else avatarNonInitials">
              <div
                class="grid h-28 w-28 place-items-center rounded-3xl ring-2 ring-white shadow-2xl
                       bg-gradient-to-br from-sky-500 to-violet-600 text-white text-4xl font-semibold
                       dark:ring-slate-900">
                {{ initials }}
              </div>
            </ng-container>

            <ng-template #avatarNonInitials>
              <ng-container *ngIf="avatarMode === 'photo'; else avatarSilhouette">
                <img [src]="profilePicturePath"
                     alt="Profile picture"
                     class="h-28 w-28 rounded-3xl object-cover ring-2 ring-white shadow-2xl
                            dark:ring-slate-900"/>
              </ng-container>
              <ng-template #avatarSilhouette>
                <div
                  class="grid h-28 w-28 place-items-center rounded-3xl bg-slate-100 text-slate-400
                         ring-2 ring-white shadow-2xl dark:bg-slate-800 dark:text-slate-500 dark:ring-slate-900">
                  <svg class="h-14 w-14" viewBox="0 0 24 24" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                  </svg>
                </div>
              </ng-template>
            </ng-template>

            <!-- edit chip -->
            <button onclick="document.getElementById('getFile').click()"
                    class="absolute -bottom-2 -right-2 inline-flex items-center gap-1 rounded-xl
                           bg-white/90 px-3 py-1.5 text-xs font-medium text-slate-700 shadow
                           ring-1 ring-slate-200 hover:bg-white dark:bg-slate-800/90 dark:text-slate-200 dark:ring-slate-700">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                <path fill-rule="evenodd" clip-rule="evenodd"
                  d="M20.848 1.879c-1.172-1.172-3.071-1.172-4.243 0L2.447 16.036a3 3 0 00-.82 1.533l-.587 2.935A2 2 0 003.393 22.858l2.936-.587a3 3 0 001.533-.82L22.019 7.293c1.171-1.172 1.171-3.071 0-4.243l-1.171-1.171z"/>
              </svg>
              Edit
            </button>
          </div>

          <!-- NAME / EMAIL / CREDENTIAL (view + inline edit for credential) -->
          <div class="flex-1">
            <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
              <div>
                <h1 class="text-2xl font-bold tracking-tight text-slate-900 dark:text-white">
                  {{ user.firstName }} {{ user.lastName }}
                </h1>
                <div class="mt-1 text-slate-600 dark:text-slate-300">
                  <span class="text-base">{{ user.email }}</span>
                </div>

                <!-- Credential chip + edit button -->
                <div class="mt-2 flex items-center gap-2">
                  <span class="inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-sm
                                border-slate-200 bg-white text-slate-700 shadow-sm
                                dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200">
                    {{ user.profileCredential || '—' }}
                  </span>
                  <button (click)="toggleProfileCredential()"
                          class="inline-flex items-center rounded-lg border border-slate-300
                                 bg-white p-2 text-xs text-slate-700 shadow-sm hover:bg-slate-50
                                 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-200"
                          aria-label="Edit profile credential">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M20.848 1.879c-1.172-1.172-3.071-1.172-4.243 0L2.447 16.036a3 3 0 00-.82 1.533l-.587 2.935A2 2 0 003.393 22.858l2.936-.587a3 3 0 001.533-.82L22.019 7.293c1.171-1.172 1.171-3.071 0-4.243l-1.171-1.171z"/>
                    </svg>
                  </button>
                </div>

                <div class="mt-2 text-sm text-slate-500 dark:text-slate-400">
                  {{ user.followers }} followers · {{ user.following }} following
                </div>
              </div>
            </div>

            <!-- Description (inline editor) -->
            <div class="mt-5">
              <div class="flex items-start gap-2">
                <p class="max-w-3xl leading-relaxed text-slate-700 dark:text-slate-300">
                  <ng-container *ngIf="user.profileDescription; else addDesc">
                    {{ user.profileDescription }}
                  </ng-container>
                  <ng-template #addDesc>
                    <span class="text-sky-600 hover:underline cursor-pointer"
                          (click)="toggleProfileDescription()">
                      Write a description about yourself
                    </span>
                  </ng-template>
                </p>
                <button (click)="toggleProfileDescription()"
                        class="mt-0.5 inline-flex items-center rounded-lg border border-slate-300
                               bg-white p-2 text-xs text-slate-700 shadow-sm hover:bg-slate-50
                               dark:border-slate-600 dark:bg-slate-800 dark:text-slate-200">
                  <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                      d="M20.848 1.879c-1.172-1.172-3.071-1.172-4.243 0L2.447 16.036a3 3 0 00-.82 1.533l-.587 2.935A2 2 0 003.393 22.858l2.936-.587a3 3 0 001.533-.82L22.019 7.293c1.171-1.172 1.171-3.071 0-4.243l-1.171-1.171z"/>
                  </svg>
                </button>
              </div>

              <app-text-popup
                class="lg:-my-24 lg:-mx-0 md:-my-44"
                *ngIf="boxDescription.display | async"
                [updateDescription]="true"
                [limit]="300"
                [title]="'Profile Description'"
                [height]="44">
              </app-text-popup>
            </div>

            <!-- Achievements -->
            <div *ngIf="completedSolutions.length > 0" class="mt-6 overflow-visible">
              <h2 class="text-lg font-bold text-slate-900 dark:text-white">Achievements</h2>
              <div class="mt-3 flex flex-wrap items-center gap-4">
                <div class="relative">
                  <img (mouseenter)="onHoverImageToggle('solution-completed')"
                       (mouseleave)="onHoverImageToggle('solution-completed')"
                       class="h-16 w-16 cursor-pointer rounded-xl border border-slate-200 bg-white p-2 shadow-sm
                              dark:border-slate-700 dark:bg-slate-800"
                       src="../../../assets/img/solution-completed-badge.png" alt="Solution Completed"/>
                  <div *ngIf="showSolutionCompletedBadge"
                       class="absolute left-20 top-1 z-50 w-72 rounded-xl border border-slate-200 bg-white p-4
                              text-sm shadow-2xl dark:border-slate-700 dark:bg-slate-900">
                    <img class="mb-3 h-24 w-full rounded-lg object-contain"
                         src="../../../assets/img/solution-completed-badge.png" alt="" />
                    <h3 class="mb-1 text-base font-semibold text-slate-900 dark:text-white">Solution Completed</h3>
                    <p class="text-slate-600 dark:text-slate-300">
                      This badge marks your first completed solution—keep going!
                    </p>
                  </div>
                </div>

                <div class="relative" *ngIf="points !== 0">
                  <img (mouseenter)="onHoverImageToggle('points')"
                       (mouseleave)="onHoverImageToggle('points')"
                       class="h-16 w-16 cursor-pointer rounded-full border border-slate-200 bg-white p-2 shadow-sm
                              dark:border-slate-700 dark:bg-slate-800"
                       src="../../../assets/img/nwg-solution-badge.png" alt="Points Badge"/>
                  <div *ngIf="showSolutionWithPointsBadge"
                       class="absolute left-20 top-1 z-50 w-72 rounded-xl border border-slate-200 bg-white p-4
                              text-sm shadow-2xl dark:border-slate-700 dark:bg-slate-900">
                    <img class="mb-3 h-24 w-full rounded-lg object-contain"
                         src="../../../assets/img/nwg-solution-badge.png" alt="" />
                    <h3 class="mb-1 text-base font-semibold text-slate-900 dark:text-white">You Got Points</h3>
                    <p class="text-slate-600 dark:text-slate-300">
                      Earn more by improving evaluations—aim for 9 to enter the tournament.
                    </p>
                  </div>
                </div>
              </div>
            </div>

          </div> <!-- /meta -->
        </div>
      </div>
    </section>

    <!-- CREDENTIALS & HIGHLIGHTS -->
    <section class="mt-8 grid grid-cols-1 gap-8 lg:grid-cols-3">
      <div class="lg:col-span-2"></div>

      <aside
        class="rounded-3xl border border-slate-200/70 bg-white/70 p-6 shadow-xl backdrop-blur
               dark:border-slate-800 dark:bg-slate-900/70">
        <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Credentials & Highlights</h2>

        <ul class="mt-4 space-y-5 text-slate-700 dark:text-slate-300">
          <!-- Employment -->
          <li class="flex items-start gap-3">
            <svg width="22" height="22" class="mt-0.5 shrink-0 dark:fill-white" viewBox="0 0 512 512">
              <path d="M277.333 0L298.667 21.333V64H426.667V362.667H0V64H128V21.333L149.333 0H277.333Z
                       M42.667 220.935V320H384V220.935C341.375 233.13 298.702 240.759 256 243.809V277.333H170.667V243.809
                       C127.965 240.759 85.292 233.131 42.667 220.935ZM384 106.667H42.667V176.433
                       C99.639 193.933 156.507 202.667 213.333 202.667S327.028 193.933 384 176.433V106.667Z
                       M256 42.667H170.667V64H256V42.667Z"/>
            </svg>
            <div class="flex-1">
              <span *ngIf="user.employement !== ''" class="font-medium">{{ user.employement }}</span>
              <span *ngIf="user.employement === ''" class="text-slate-500">—</span>
            </div>
            <button (click)="toggleEmployementCredential()"
                    class="ml-2 rounded-md border border-slate-300 bg-white p-2 text-xs text-slate-700 shadow-sm
                           hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-200">
              Edit
            </button>
          </li>

          <!-- Education -->
          <li class="flex items-start gap-3">
            <svg width="22" height="22" class="mt-0.5 shrink-0 dark:fill-white" viewBox="0 0 1024 1024">
              <path d="M197.8 791.8l60.7-286.9c2.3-11.1-4.7-21.9-15.8-24.3s-21.9 4.7-24.3 15.8l-60.7 286.9
                       c-2.3 11.1 4.7 21.9 15.8 24.3 11.1 2.3 21.9-4.7 24.3-15.8zm571.1-286.8l61.8 287.1c2.4 11.1 13.3 18.1 24.3 15.7
                       11.1-2.4 18.1-13.3 15.7-24.3l-61.8-287.1c-2.4-11.1-13.3-18.1-24.3-15.7-11.1 2.4-18.1 13.3-15.7 24.3z"/>
              <path d="M967.5 386.9L535.9 208.1c-10.6-4.4-30.6-4.4-41.2-.1L57.8 386.9l436.9 178.9c10.6 4.4 30.6 4.3 41.2-.1l431.6-178.8z"/>
            </svg>
            <div class="flex-1">
              <span *ngIf="user.education !== ''" class="font-medium">{{ user.education }}</span>
              <span *ngIf="user.education === ''" class="text-slate-500">—</span>
            </div>
            <button (click)="toggleEducationCredential()"
                    class="ml-2 rounded-md border border-slate-300 bg-white p-2 text-xs text-slate-700 shadow-sm
                           hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-200">
              Edit
            </button>
          </li>

          <!-- Location -->
          <li class="flex items-start gap-3">
            <svg width="22" height="22" class="mt-0.5 shrink-0 dark:fill-white" viewBox="0 0 64 64">
              <path d="M32 0C18.7 0 8 10.7 8 24c0 5.7 2.5 10.7 5.3 15L30.4 63.2c.3.5.9.8 1.6.8s1.3-.3 1.6-.8L50.7 39
                       C53.4 35.4 56 29.7 56 24 56 10.7 45.3 0 32 0zM48.1 39L32 61 15.9 39C13.5 35.5 10 29.8 10 24 10 11.8 19.8 2 32 2
                       s22 9.8 22 22c0 5.8-3.7 11.5-5.9 15z"/>
            </svg>
            <div class="flex-1">
              <span *ngIf="user.location !== ''" class="font-medium">{{ user.location }}</span>
              <span *ngIf="user.location === ''" class="text-slate-500">—</span>
            </div>
            <button (click)="toggleLocationCredential()"
                    class="ml-2 rounded-md border border-slate-300 bg-white p-2 text-xs text-slate-700 shadow-sm
                           hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-200">
              Edit
            </button>
          </li>

          <!-- Points + Joined -->
          <li class="flex items-center gap-3">
            <img class="h-6 w-6 rounded-full" src="../../../assets/img/nwg-solution-badge.png" alt="">
            <span>Points: <strong>{{ points || '__' }}</strong></span>
          </li>

          <li class="flex items-start gap-3">
            <svg width="22" height="22" class="mt-0.5 shrink-0 dark:fill-white" viewBox="0 0 32 32">
              <path d="M28.5 13.8c0-4.6-2.3-8.8-6-11.3l1-1.7c.1-.2.1-.6-.2-.7-.2-.1-.6-.1-.7.2l-1 1.7C19.2 1.6 17.4 1 15.5 1
                       9.7 1 5 5.7 5 11.5c0 3.6 1.8 6.8 4.6 8.7l-1.1 1.9a12.5 12.5 0 0011 1.7V31h-3a.5.5 0 000 1h7a.5.5 0 000-1h-3v-3.5
                       c5.5-.1 11.5-6.2 11.5-13.7zM6.8 11.5c0-5.2 4.3-9.5 9.5-9.5s9.5 4.3 9.5 9.5-4.3 9.5-9.5 9.5-9.5-4.3-9.5-9.5z"/>
            </svg>
            <span>Joined in {{ dateJoined }}</span>
          </li>
        </ul>
      </aside>
    </section>

    <!-- SOLUTIONS -->
    <section class="mt-10">
      <h2 class="text-center text-2xl font-bold text-slate-900 underline underline-offset-8 dark:text-white">
        Solutions ({{ completedSolutions.length }})
      </h2>

      <div class="mt-6 grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4">
        <div *ngFor="let solution of completedSolutions; let i = index"
             class="min-w-0 transition-transform duration-200 hover:scale-[1.01]">
          <app-solution [user]="user" [solution]="solution"></app-solution>
        </div>
      </div>
    </section>
  </div>

  <app-footer class="md:hidden"></app-footer>
</div>

<app-chatbot></app-chatbot>

<!-- LOCATION MODAL (unchanged behavior) -->
<div id="location-modal" class="w-full max-w-md max-h-full fixed inset-x-0 mx-auto top-[10rem] z-50 p-4 flex"
     *ngIf="displayPromptLocation">
  <div class="relative p-4 w-full max-w-md max-h-full">
    <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
      <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          Enter Location<span class="text-red-600">*</span>
        </h3>
        <button (click)="closeDisplayPromptLocation()" type="button"
                class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm h-8 w-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white">
          <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
          </svg>
          <span class="sr-only">Close modal</span>
        </button>
      </div>

      <div class="p-4 md:p-5">
        <label for="locationInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          Location (e.g. Philadelphia, PA)
        </label>
        <input id="locationInput" [(ngModel)]="location" type="text"
               class="block w-full p-2.5 bg-gray-50 border border-gray-300 text-gray-900
                      text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500
                      dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"
               placeholder="Philadelphia, PA">

        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
          <span class="text-red-600">*</span> We ask for your location so we can recommend people who are nearby and to
          help build a community showing where each solution is developed.
        </p>

        <div class="mt-4 flex justify-end space-x-2">
          <button (click)="RejectSubmitLocation()" type="button"
                  class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white
                         bg-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:outline-none
                         focus:ring-red-300 dark:bg-red-500 dark:hover:bg-red-600 dark:focus:ring-red-700">
            Don't Share
          </button>
          <button (click)="submitLocation()" type="button"
                  class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white
                         bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:outline-none
                         focus:ring-blue-300 dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-700">
            Share
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- === FIXED, CENTERED POPUP WRAPPERS === -->
<!-- Profile Credential (NEW overlay for inline edit button) -->
<div *ngIf="boxProfile.display | async" class="fixed inset-0 z-[100] grid place-items-center bg-black/40">
  <app-text-popup
    [updateProfileCredential]="true"
    [title]="'Profile Credential'"
    [limit]="60">
  </app-text-popup>
</div>

<div *ngIf="boxEmployment.display | async" class="fixed inset-0 z-[100] grid place-items-center bg-black/40">
  <app-text-popup
    [updateEmploymentCredential]="true"
    [limit]="60"
    [title]="'Employment Credentials'">
  </app-text-popup>
</div>

<div *ngIf="boxEducation.display | async" class="fixed inset-0 z-[100] grid place-items-center bg-black/40">
  <app-text-popup
    [updateEducationCredential]="true"
    [limit]="60"
    [title]="'Education Credentials'">
  </app-text-popup>
</div>

<div *ngIf="boxLocation.display | async" class="fixed inset-0 z-[100] grid place-items-center bg-black/40">
  <app-text-popup
    [updateLocationCredential]="true"
    [limit]="60"
    [title]="'Location Credentials'">
  </app-text-popup>
</div>
