<div class="dark:bg-slate-900 min-h-screen text-slate-900 dark:text-slate-100">
  <!-- Navbars (unchanged) -->
  <div *ngIf="!isLoggedIn"><app-navbar></app-navbar></div>
  <div *ngIf="isLoggedIn">
    <app-navbar
      [hoveredOtherAisPath]="'bg-gray-100 dark:bg-gray-700'"
      [showMoreOrLess]="true"
      [sideBarSmall]="true"
      [sideBarBig]="false"
      [email]="this.auth.currentUser.email"
      [firstName]="this.auth.currentUser.firstName"
      [lastName]="this.auth.currentUser.lastName"
      [path]="'home'">
    </app-navbar>
  </div>

  <app-management-toolbar></app-management-toolbar>

  <!-- Page body -->
  <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 py-8 mt-10">
    <div class="rounded-2xl border border-slate-200 dark:border-slate-700 p-6 bg-white dark:bg-slate-800">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-xl md:text-2xl font-bold">Bulk Mail</h1>
          <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
            Step 1 — Build your HTML email.
          </p>
        </div>

        <button type="button"
                (click)="openModal()"
                class="inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-medium bg-indigo-600 text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400">
          Build template
        </button>
      </div>
    </div>
  </div>

<!-- Daily Report (Summary + Histogram) -->
<div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 mb-6">
  <div class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 p-4 md:p-5">
    <!-- Header / Controls -->
    <div class="flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-4 justify-between mb-4">
      <div>
        <h2 class="text-base md:text-lg font-semibold">Daily Report</h2>
        <p class="text-xs opacity-70">Summary for the selected day (local time)</p>
      </div>

      <!-- Controls -->
      <div class="flex flex-wrap items-center gap-2">
        <!-- DAY CONTROLS -->
        <ng-container *ngIf="!isMonthMode; else monthControls">
          <button type="button"
                  (click)="shiftDay(-1)"
                  class="rounded-lg px-3 py-1.5 text-xs ring-1 ring-slate-300 dark:ring-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700">
            ← Previous
          </button>

          <input type="date"
                class="rounded-lg border border-slate-300 dark:border-slate-600 bg-transparent px-3 py-1.5 text-sm
                        text-slate-900 dark:text-slate-100 outline-none focus:ring-2 focus:ring-indigo-500"
                [value]="selectedDate"
                (change)="onDateChange($event)"/>

          <button type="button"
                  (click)="shiftDay(1)"
                  class="rounded-lg px-3 py-1.5 text-xs ring-1 ring-slate-300 dark:ring-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700">
            Next →
          </button>

          <button type="button"
                  (click)="resetToToday()"
                  class="rounded-lg px-3 py-1.5 text-xs bg-indigo-600 text-white hover:bg-indigo-700">
            Today
          </button>
        </ng-container>

        <!-- MONTH CONTROLS -->
        <ng-template #monthControls>
          <button type="button"
                  (click)="shiftMonth(-1)"
                  class="rounded-lg px-3 py-1.5 text-xs ring-1 ring-slate-300 dark:ring-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700">
            ← Previous
          </button>

          <!-- Month/Year selector -->
          <input type="month"
                class="rounded-lg border border-slate-300 dark:border-slate-600 bg-transparent px-3 py-1.5 text-sm
                        text-slate-900 dark:text-slate-100 outline-none focus:ring-2 focus:ring-indigo-500"
                [value]="selectedMonth"
                (change)="onMonthChange($event)"/>

          <button type="button"
                  (click)="shiftMonth(1)"
                  class="rounded-lg px-3 py-1.5 text-xs ring-1 ring-slate-300 dark:ring-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700">
            Next →
          </button>

          <button type="button"
                  (click)="resetToThisMonth()"
                  class="rounded-lg px-3 py-1.5 text-xs bg-indigo-600 text-white hover:bg-indigo-700">
            This Month
          </button>
        </ng-template>

        <!-- View toggle -->
        <button type="button"
                (click)="showDay()"
                class="rounded-lg px-3 py-1.5 text-xs"
                [class.bg-indigo-600]="!isMonthMode"
                [class.text-white]="!isMonthMode"
                [class.ring-1]="isMonthMode"
                [class.ring-slate-300]="isMonthMode"
                [class.dark:ring-slate-600]="isMonthMode">
          Day
        </button>

        <button type="button"
                (click)="showMonth()"
                class="rounded-lg px-3 py-1.5 text-xs"
                [class.bg-indigo-600]="isMonthMode"
                [class.text-white]="isMonthMode"
                [class.ring-1]="!isMonthMode"
                [class.ring-slate-300]="!isMonthMode"
                [class.dark:ring-slate-600]="!isMonthMode">
          Month
        </button>
      </div>
    </div>

    <!-- KPI Row -->
    <div *ngIf="!summaryLoading; else dayLoading" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-2">
      <div class="rounded-xl ring-1 ring-slate-200 dark:ring-slate-700 p-3">
        <div class="text-[11px] opacity-70">Requested</div>
        <div class="text-lg font-semibold">{{ (isMonthMode ? monthSummary.requested : daySummary.requested) | number }}</div>
      </div>
      <div class="rounded-xl ring-1 ring-emerald-200 dark:ring-emerald-900/40 p-3">
        <div class="text-[11px] opacity-70">Succeeded</div>
        <div class="text-lg font-semibold text-emerald-600">{{ (isMonthMode ? monthSummary.succeeded : daySummary.succeeded) | number }}</div>
      </div>
      <div class="rounded-xl ring-1 ring-rose-200 dark:ring-rose-900/40 p-3">
        <div class="text-[11px] opacity-70">Failed</div>
        <div class="text-lg font-semibold text-rose-600">{{ (isMonthMode ? monthSummary.failed : daySummary.failed) | number }}</div>
      </div>
      <div class="rounded-xl ring-1 ring-slate-200 dark:ring-slate-700 p-3">
        <div class="text-[11px] opacity-70">Invalid</div>
        <div class="text-lg font-semibold">{{ (isMonthMode ? monthSummary.invalid : daySummary.invalid) | number }}</div>
      </div>
      <div class="rounded-xl ring-1 ring-slate-200 dark:ring-slate-700 p-3">
        <div class="text-[11px] opacity-70">Duplicates</div>
        <div class="text-lg font-semibold">{{ (isMonthMode ? monthSummary.duplicates : daySummary.duplicates) | number }}</div>
      </div>
      <div class="rounded-xl ring-1 ring-slate-200 dark:ring-slate-700 p-3">
        <div class="text-[11px] opacity-70">Runs</div>
        <div class="text-lg font-semibold">{{ isMonthMode ? monthDays.length : dayRuns.length }}</div>
      </div>
    </div>

    <ng-template #dayLoading>
      <div class="text-xs opacity-70">Loading summary…</div>
    </ng-template>

    <!-- Histogram -->
    <div class="mt-4">
      <div class="flex items-center justify-between mb-1">
        <div class="text-xs opacity-70" *ngIf="!isMonthMode">Sends per hour (0–23)</div>
        <div class="text-xs opacity-70" *ngIf="isMonthMode">Sends per day (1–{{ monthDays.length }})</div>
        <div class="flex items-center gap-3 text-[11px] opacity-80">
          <span class="inline-flex items-center gap-1">
            <span class="inline-block w-3 h-3 rounded-sm bg-emerald-500/70"></span> Succeeded
          </span>
          <span class="inline-flex items-center gap-1">
            <span class="inline-block w-3 h-3 rounded-sm bg-rose-500/70"></span> Failed
          </span>
        </div>
      </div>

      <!-- DAY MODE -->
      <div class="w-full overflow-x-auto" *ngIf="!isMonthMode">
        <!-- left gutter 20px for Y labels -->
        <svg [attr.viewBox]="'0 0 ' + (24 * 16 + 24) + ' 120'" class="w-[864px] max-w-full h-32">
          <!-- Y grid + labels -->
          <g>
            <ng-container *ngFor="let t of yTicks">
              <line [attr.x1]="20" [attr.y1]="t.y" [attr.x2]="24 * 16 + 20" [attr.y2]="t.y"
                    stroke="currentColor" class="opacity-10"></line>
              <text [attr.x]="18" [attr.y]="t.y + 3" text-anchor="end"
                    class="fill-current opacity-60" font-size="8">{{ t.label }}</text>
            </ng-container>
          </g>

          <!-- baseline -->
          <line [attr.x1]="20" [attr.y1]="110" [attr.x2]="24 * 16 + 20" [attr.y2]="110"
                stroke="currentColor" class="opacity-20"></line>

          <!-- bars + hour ticks -->
          <ng-container *ngFor="let h of hours; let i = index">
            <ng-container *ngIf="maxBin > 0">
              <rect
                [attr.x]="i * 16 + 2 + 20"
                [attr.y]="110 - Math.round(100 * binsFailed[i] / maxBin)"
                [attr.width]="12"
                [attr.height]="Math.round(100 * binsFailed[i] / maxBin)"
                class="fill-rose-500/70"></rect>

              <rect
                [attr.x]="i * 16 + 2 + 20"
                [attr.y]="110 - Math.round(100 * (binsFailed[i] + binsSucceeded[i]) / maxBin)"
                [attr.width]="12"
                [attr.height]="Math.round(100 * binsSucceeded[i] / maxBin)"
                class="fill-emerald-500/70"></rect>
            </ng-container>

            <text [attr.x]="i * 16 + 8 + 20" [attr.y]="118" text-anchor="middle"
                  class="fill-current opacity-60" font-size="8">{{ i }}</text>
          </ng-container>
        </svg>
      </div>

      <!-- MONTH MODE -->
      <div class="w-full overflow-x-auto" *ngIf="isMonthMode">
        <!-- left gutter 20px; dynamic width by number of days -->
        <svg
          [attr.viewBox]="'0 0 ' + (monthDays.length * 16 + 24) + ' 120'"
          class="max-w-full h-32"
          [style.width.px]="Math.max(864, monthDays.length * 16 + 24)">
          <!-- Y grid + labels -->
          <g>
            <ng-container *ngFor="let t of yTicks">
              <line [attr.x1]="20" [attr.y1]="t.y" [attr.x2]="monthDays.length * 16 + 20" [attr.y2]="t.y"
                    stroke="currentColor" class="opacity-10"></line>
              <text [attr.x]="18" [attr.y]="t.y + 3" text-anchor="end"
                    class="fill-current opacity-60" font-size="8">{{ t.label }}</text>
            </ng-container>
          </g>

          <!-- baseline -->
          <line [attr.x1]="20" [attr.y1]="110" [attr.x2]="monthDays.length * 16 + 20" [attr.y2]="110"
                stroke="currentColor" class="opacity-20"></line>

          <!-- bars + day labels -->
          <ng-container *ngFor="let d of monthDays; let idx = index">
            <ng-container *ngIf="monthMaxBin > 0">
              <rect
                [attr.x]="idx * 16 + 2 + 20"
                [attr.y]="110 - Math.round(100 * monthBinsFailed[idx] / monthMaxBin)"
                [attr.width]="12"
                [attr.height]="Math.round(100 * monthBinsFailed[idx] / monthMaxBin)"
                class="fill-rose-500/70"></rect>

              <rect
                [attr.x]="idx * 16 + 2 + 20"
                [attr.y]="110 - Math.round(100 * (monthBinsFailed[idx] + monthBinsSucceeded[idx]) / monthMaxBin)"
                [attr.width]="12"
                [attr.height]="Math.round(100 * monthBinsSucceeded[idx] / monthMaxBin)"
                class="fill-emerald-500/70"></rect>
            </ng-container>

            <text [attr.x]="idx * 16 + 8 + 20" [attr.y]="118" text-anchor="middle"
                  class="fill-current opacity-60" font-size="8">{{ d }}</text>
          </ng-container>
        </svg>
      </div>
    </div>
  </div>
</div>


  <!-- Reports: latest sends -->
<div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 mb-6">
  <div class="rounded-2xl border border-slate-200 dark:border-slate-700 p-4 bg-white dark:bg-slate-800">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-sm font-semibold">Send Reports</h2>
      <div class="text-xs opacity-70">Showing your latest {{ reports.length }} run(s)</div>
    </div>

    <div *ngIf="!reports.length" class="text-xs opacity-70">No sends yet.</div>

    <div class="space-y-2">
      <details *ngFor="let r of reports" class="group rounded-lg ring-1 ring-slate-200 dark:ring-slate-700">
        <summary class="cursor-pointer list-none select-none px-3 py-2 flex items-center gap-3">
          <span class="text-sm font-medium truncate">{{ r.title }}</span>
          <span class="text-xs opacity-70">• {{ r.subject }}</span>
          <span class="text-xs ml-auto opacity-70" *ngIf="r.createdAt as ts">
            {{ ts.toDate() | date:'MMM d, y, h:mm a' }}
          </span>
          <span class="text-[10px] ml-2 px-2 py-0.5 rounded-full"
                [class.bg-emerald-100]="r.status==='completed'"
                [class.text-emerald-800]="r.status==='completed'"
                [class.bg-amber-100]="r.status!=='completed'"
                [class.text-amber-800]="r.status!=='completed'">
            {{ r.status }}
          </span>
        </summary>

        <div class="px-3 pb-3 text-xs">
          <div class="flex flex-wrap gap-x-4 gap-y-1 mb-2">
            <span>Requested: <b>{{ r.totals.requested }}</b></span>
            <span>Valid: <b>{{ r.totals.valid }}</b></span>
            <span>Invalid: <b>{{ r.totals.invalid }}</b></span>
            <span>Duplicates: <b>{{ r.totals.duplicates }}</b></span>
            <span>Batches: <b>{{ r.batches.length || 0 }}</b></span>
          </div>

          <div class="overflow-auto max-h-40 pr-1">
            <table class="w-full text-[11px]">
              <thead class="text-left opacity-70">
                <tr>
                  <th class="py-1 pr-2">#</th>
                  <th class="py-1 pr-2">Count</th>
                  <th class="py-1 pr-2">Status</th>
                  <th class="py-1 pr-2">Message Id</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let b of r.batches; let i = index" class="border-t border-slate-100 dark:border-slate-700">
                  <td class="py-1 pr-2">{{ i + 1 }}</td>
                  <td class="py-1 pr-2">{{ b.count }}</td>
                  <td class="py-1 pr-2">{{ b.statusCode || '—' }}</td>
                  <td class="py-1 pr-2 truncate">{{ b.messageId || '—' }}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="mt-2 flex items-center gap-2">
            <button type="button" (click)="deleteReport(r.runId)"
                    class="rounded px-2 py-1 ring-1 ring-slate-300 dark:ring-slate-600 hover:bg-rose-50 dark:hover:bg-rose-900/20 text-rose-600">
              Delete report
            </button>
          </div>
        </div>
      </details>
    </div>
  </div>
</div>

</div>




<!-- Modal -->
<div *ngIf="showModal" class="fixed inset-0 z-[100]">
  <!-- Backdrop -->
  <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" (click)="closeModal()"></div>

  <!-- Scrollable overlay wrapper -->
  <div class="fixed inset-0 overflow-y-auto">
    <div class="flex min-h-full items-start justify-center p-4 sm:p-6">
      <!-- Panel -->
      <div role="dialog" aria-modal="true" aria-labelledby="templateModalTitle"
           class="w-full max-w-6xl rounded-2xl bg-white dark:bg-slate-900 shadow-2xl ring-1 ring-black/10 dark:ring-white/10
                  overflow-hidden flex flex-col max-h-screen text-slate-900 dark:text-slate-100">

        <!-- Header -->
        <div class="flex items-center justify-between px-4 md:px-6 py-4 border-b border-slate-200 dark:border-slate-800 shrink-0">
          <div class="flex items-center gap-3">
            <h2 id="templateModalTitle" class="text-lg md:text-xl font-semibold">Template Visualizer</h2>
            <span class="text-xs px-2 py-1 rounded-md ring-1 ring-slate-300 dark:ring-slate-700 opacity-75">
              Sandboxed Preview
            </span>
          </div>
          <div class="flex items-center gap-2">
            <button type="button"
                    (click)="loadSample()"
                    class="rounded-lg px-3 py-1.5 text-xs ring-1 ring-slate-300 dark:ring-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800">
              Load sample
            </button>
            <button type="button"
                    (click)="closeModal()"
                    class="rounded-lg px-3 py-1.5 text-xs ring-1 ring-slate-300 dark:ring-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800">
              Close
            </button>
          </div>
        </div>

        <!-- Body -->
        <div class="flex-1 overflow-hidden">
          <div class="grid grid-cols-1 md:grid-cols-2 h-full min-h-0">
            <!-- Left: Editor -->
            <section class="p-4 md:p-6 border-b md:border-b-0 md:border-r border-slate-200 dark:border-slate-800
                    flex flex-col min-h-0">
              <!-- Scrollable content -->
                    <form [formGroup]="form" class="flex-1 min-h-0 flex flex-col space-y-4 overflow-auto pr-1">
                        <!-- Subject -->
                        <div class="shrink-0">
                        <label class="block text-sm font-medium mb-1">Email Subject</label>
                        <div class="flex items-center gap-2">
                            <input formControlName="subject" type="text"
                                placeholder="e.g., Welcome to NewWorld Game"
                                class="w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-transparent
                                        px-3 py-2 outline-none focus:ring-2 ring-offset-0 focus:ring-indigo-500
                                        placeholder-slate-400 dark:placeholder-slate-400
                                        text-slate-900 dark:text-slate-100"/>
                            <button type="button" (click)="copySubject()"
                                    class="rounded-lg ring-1 ring-slate-300 dark:ring-slate-600 px-3 py-2 text-xs hover:bg-slate-100 dark:hover:bg-slate-800">
                            <span *ngIf="copiedSubject">✓ Copied</span>
                            <span *ngIf="!copiedSubject">Copy</span>
                            </button>
                        </div>
                        </div>

                        <!-- HTML + toolbar -->
                        <div class="shrink-0">
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-sm font-medium">HTML</label>
                            <div class="flex items-center gap-2">
                            <button type="button" (click)="onPickImage()"
                                    class="rounded-lg px-3 py-1.5 text-xs ring-1 ring-slate-300 dark:ring-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800">
                                Insert image
                            </button>
                            <input #fileInput id="getFile" type="file" accept="image/*" class="hidden"
                                    (change)="onImageChosen($event)"/>
                            <span *ngIf="isUploading" class="text-xs opacity-70">Uploading… {{uploadProgressText}}</span>
                            </div>
                        </div>

                        <div class="relative">
                            <textarea #htmlEditor formControlName="html" (input)="recompute()" rows="14"
                                    placeholder="Paste full HTML here…"
                                    class="w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-transparent
                                            px-3 py-3 font-mono text-sm leading-6 outline-none focus:ring-2 ring-offset-0 focus:ring-indigo-500
                                            placeholder-slate-400 dark:placeholder-slate-400
                                            text-slate-900 dark:text-slate-100"></textarea>

                            <div class="absolute right-2 bottom-2 flex gap-2">
                            <button type="button" (click)="copyHtml()"
                                    class="rounded-md px-3 py-1.5 text-xs ring-1 ring-slate-300 dark:ring-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800">
                                <span *ngIf="copiedHtml">✓ Copied</span>
                                <span *ngIf="!copiedHtml">Copy</span>
                            </button>
                            </div>
                        </div>

                        <div class="mt-1 flex items-center justify-between text-xs opacity-70">
                            <span>Chars: {{ (form.value.html || '').length | number }}</span>
                            <span>Lines: {{ lineCount }}</span>
                            <span>Size: {{ totalBytes | number }} B</span>
                        </div>
                        </div>

                        <!-- Options (standalone ngModel) -->
                        <div class="shrink-0">
                        <div class="flex flex-wrap gap-3 items-center text-xs">
                            <label class="inline-flex items-center gap-2">
                            <input type="checkbox" class="h-4 w-4"
                                    [(ngModel)]="wrapHtml" [ngModelOptions]="{standalone:true}"/>
                            <span class="opacity-80">Wrap with boilerplate</span>
                            </label>
                            <label class="inline-flex items-center gap-2">
                            <span class="opacity-80">Base URL:</span>
                            <input [(ngModel)]="baseUrl" [ngModelOptions]="{standalone:true}"
                                    class="px-2 py-1 rounded-md bg-transparent border border-slate-300 dark:border-slate-600 w-56
                                            placeholder-slate-400 dark:placeholder-slate-400
                                            text-slate-900 dark:text-slate-100"
                                    placeholder="https://example.com/"/>
                            </label>
                        </div>
                        </div>
                        <!-- CSV Import -->
                        <div class="shrink-0">
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-sm font-medium">CSV Recipients</label>
                            <div class="flex items-center gap-2">
                            <button type="button" (click)="pickCsv()"
                                    class="rounded-lg px-3 py-1.5 text-xs ring-1 ring-slate-300 dark:ring-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800">
                                Import CSV
                            </button>
                            <button type="button" (click)="downloadSampleCsv()"
                                    class="rounded-lg px-3 py-1.5 text-xs ring-1 ring-slate-300 dark:ring-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800">
                                Sample CSV
                            </button>
                            <input #csvInput type="file" accept=".csv,text/csv" class="hidden" (change)="onCsvChosen($event)"/>
                            </div>
                        </div>

                        <!-- Summary & actions -->
                        <div class="text-xs opacity-80 mb-2">
                            <span>Valid: <strong>{{ csvValid.length }}</strong></span>
                            <span class="mx-2">•</span>
                            <span>Invalid: <strong>{{ csvInvalid.length }}</strong></span>
                            <span class="mx-2">•</span>
                            <span>Duplicates removed: <strong>{{ csvDupes }}</strong></span>
                        </div>

                        <div class="flex flex-wrap items-center gap-2 mb-2">
                            <button type="button"
                                    (click)="sendBulk()"
                                    [disabled]="sendingBulk || !canSendBulk"
                                    class="inline-flex items-center gap-2 rounded-lg px-3 py-2 text-xs bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50">
                            <span *ngIf="!sendingBulk">Send bulk ({{ csvValid.length }})</span>
                            <span *ngIf="sendingBulk">Sending… {{ bulkProgressText }}</span>
                            </button>
                            <button type="button" (click)="clearCsv()"
                                    class="rounded-lg px-3 py-2 text-xs ring-1 ring-slate-300 dark:ring-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800">
                            Clear list
                            </button>
                            <div class="text-xs opacity-80" *ngIf="bulkResult">{{ bulkResult }}</div>
                        </div>

                        <!-- Preview list (scroll-capped) -->
                        <div *ngIf="csvValid.length || csvInvalid.length" class="max-h-40 overflow-auto pr-1">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            <div>
                                <div class="text-[11px] font-medium mb-1">Valid Emails</div>
                                <ul class="text-[11px] space-y-0.5">
                                <li *ngFor="let e of csvValid; let i = index">
                                    {{ i + 1 }}. {{ e }}
                                </li>
                                </ul>
                            </div>
                            <div *ngIf="csvInvalid.length">
                                <div class="text-[11px] font-medium mb-1 text-rose-500">Invalid Rows</div>
                                <ul class="text-[11px] space-y-0.5 text-rose-500">
                                <li *ngFor="let e of csvInvalid; let i = index">
                                    {{ i + 1 }}. {{ e }}
                                </li>
                                </ul>
                            </div>
                            </div>
                        </div>
                        </div>


                        <!-- Recent uploads (its own scroll, capped height) -->
                        <div *ngIf="recentUploads.length" class="pt-2">
                        <div class="text-xs opacity-70 mb-1">Recent uploads (click to insert):</div>
                        <div class="max-h-48 overflow-auto pr-1">
                            <div class="grid grid-cols-3 sm:grid-cols-4 gap-2">
                            <button type="button"
                                    *ngFor="let img of recentUploads"
                                    (click)="insertImageAtCursor(img.url)"
                                    class="group ring-1 ring-slate-200 dark:ring-slate-700 rounded-md overflow-hidden hover:ring-indigo-400">
                                <img [src]="img.url" [alt]="img.name" class="w-full h-24 object-cover">
                                <div class="px-2 py-1 text-[10px] truncate text-slate-600 dark:text-slate-300 group-hover:text-indigo-500">
                                {{ img.name }}
                                </div>
                            </button>
                            </div>
                        </div>
                        </div>
                    </form>

                <!-- Sticky footer actions (always visible) -->
                <!-- Sticky footer actions (always visible) -->
                    <div class="shrink-0 sticky bottom-0 left-0 right-0 pt-2
                                bg-white/90 dark:bg-slate-900/90 backdrop-blur supports-[backdrop-filter]:backdrop-blur
                                border-t border-slate-200 dark:border-slate-800">
                    <div class="flex flex-col gap-2">
                        <!-- NEW: Recipients quick controls -->
                        <div class="flex flex-wrap items-center gap-2">
                        <button type="button" (click)="pickCsv()"
                                class="rounded-lg px-3 py-1.5 text-xs ring-1 ring-slate-300 dark:ring-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800">
                            Import CSV
                        </button>
                        <button type="button" (click)="downloadSampleCsv()"
                                class="rounded-lg px-3 py-1.5 text-xs ring-1 ring-slate-300 dark:ring-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800">
                            Sample CSV
                        </button>

                        <!-- hidden input lives here so it’s always present -->
                        <input #csvInput type="file" accept=".csv,text/csv" class="hidden" (change)="onCsvChosen($event)"/>

                        <span class="text-xs opacity-80">
                            <strong>{{ csvValid.length }}</strong> valid
                            <span *ngIf="csvInvalid.length"> • <span class="text-rose-500">{{ csvInvalid.length }}</span> invalid</span>
                            <span *ngIf="csvDupes"> • {{ csvDupes }} dupes</span>
                        </span>

                        <button *ngIf="csvValid.length || csvInvalid.length" type="button" (click)="clearCsv()"
                                class="ml-auto rounded-lg px-3 py-1.5 text-xs ring-1 ring-slate-300 dark:ring-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800">
                            Clear list
                        </button>

                        <button type="button"
                                (click)="sendBulk()"
                                [disabled]="sendingBulk || !canSendBulk"
                                class="rounded-lg px-3 py-1.5 text-xs bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50">
                            <span *ngIf="!sendingBulk">Send bulk ({{ csvValid.length }})</span>
                            <span *ngIf="sendingBulk">Sending… {{ bulkProgressText }}</span>
                        </button>

                        <span class="text-xs opacity-70" *ngIf="bulkResult">{{ bulkResult }}</span>
                        </div>

                        <!-- Send test row -->
                        <div class="flex flex-wrap items-center gap-2">
                        <input [(ngModel)]="testEmail" [ngModelOptions]="{standalone:true}" type="email"
                                placeholder="Send test to: name@example.com"
                                class="min-w-[14rem] flex-1 rounded-lg border border-slate-300 dark:border-slate-600 bg-transparent
                                        px-3 py-2 text-sm placeholder-slate-400 dark:placeholder-slate-400
                                        text-slate-900 dark:text-slate-100 outline-none focus:ring-2 focus:ring-indigo-500"/>

                        <input [(ngModel)]="testPreheader" [ngModelOptions]="{standalone:true}" type="text"
                                placeholder="Optional preheader"
                                class="hidden sm:block min-w-[12rem] flex-1 rounded-lg border border-slate-300 dark:border-slate-600 bg-transparent
                                        px-3 py-2 text-sm placeholder-slate-400 dark:placeholder-slate-400
                                        text-slate-900 dark:text-slate-100 outline-none focus:ring-2 focus:ring-indigo-500"/>

                        <button type="button" (click)="sendTest()"
                                [disabled]="sending || !canSendTest"
                                class="inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm
                                        bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50">
                            <span *ngIf="!sending">Send test</span>
                            <span *ngIf="sending">Sending…</span>
                        </button>

                        <div class="text-xs opacity-70" *ngIf="sendResult">{{ sendResult }}</div>
                        </div>

                        <!-- Existing action buttons -->
                        <div class="flex items-center gap-3">
                        <button type="button" (click)="downloadHtml()"
                                class="rounded-lg px-3 py-2 text-sm ring-1 ring-slate-300 dark:ring-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800">
                            Download .html
                        </button>
                        <button type="button" (click)="openInNewTab()"
                                class="rounded-lg px-3 py-2 text-sm ring-1 ring-slate-300 dark:ring-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800">
                            Open in new tab
                        </button>
                        <button type="button" (click)="resetForm()"
                                class="ml-auto rounded-lg px-3 py-2 text-sm bg-rose-600 text-white hover:bg-rose-700">
                            Clear
                        </button>
                        </div>
                    </div>
                    </div>

            </section>

            <!-- Right: Preview -->
            <section class="p-4 md:p-6 overflow-auto">
              <div class="flex items-center justify-between mb-2">
                <div class="text-sm opacity-80">Live Preview (sandboxed)</div>
                <div class="flex items-center gap-2 text-xs">
                  <button type="button" class="px-3 py-1 rounded-lg ring-1 ring-slate-300 dark:ring-slate-600"
                          [class.bg-slate-900]="previewWidth==='desktop'"
                          [class.text-white]="previewWidth==='desktop'"
                          (click)="setPreview('desktop')">Desktop</button>
                  <button type="button" class="px-3 py-1 rounded-lg ring-1 ring-slate-300 dark:ring-slate-600"
                          [class.bg-slate-900]="previewWidth==='tablet'"
                          [class.text-white]="previewWidth==='tablet'"
                          (click)="setPreview('tablet')">Tablet</button>
                  <button type="button" class="px-3 py-1 rounded-lg ring-1 ring-slate-300 dark:ring-slate-600"
                          [class.bg-slate-900]="previewWidth==='mobile'"
                          [class.text-white]="previewWidth==='mobile'"
                          (click)="setPreview('mobile')">Mobile</button>
                </div>
              </div>

              <div class="mx-auto border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden bg-white dark:bg-slate-800"
                   [ngStyle]="previewFrameStyle">
                <div class="h-96 md:h-[32rem] w-full">
                  <iframe title="Email Preview"
                          class="w-full h-full"
                          [srcdoc]="finalHtml || placeholderHtml"
                          sandbox="allow-forms allow-pointer-lock allow-same-origin"
                          referrerpolicy="no-referrer">
                  </iframe>
                </div>
              </div>

              <p class="text-xs opacity-60 mt-3">
                Scripts are removed and preview is sandboxed. Use Base URL for relative links.
              </p>
            </section>
          </div>
        </div>
      </div>
      <!-- /Panel -->
    </div>
  </div>
</div>
